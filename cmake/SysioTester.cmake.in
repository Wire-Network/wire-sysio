cmake_minimum_required(VERSION 3.15)

message(STATUS "Setting up Sysio Tester @VERSION_FULL@ at @SYS_ROOT_DIR@")

# VERSION
set(SYSIO_VERSION "@VERSION_FULL@")

# Forward compilers
set(CMAKE_CXX_COMPILER @CMAKE_CXX_COMPILER@)
set(CMAKE_C_COMPILER   @CMAKE_C_COMPILER@)

# C++ config
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_EXTENSIONS ON)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Flags
set(CMAKE_CXX_FLAGS "${CMAKE_C_FLAGS} ${CMAKE_CXX_FLAGS} -Wall")
if(APPLE)
    string(APPEND CMAKE_CXX_FLAGS " -Wno-deprecated-declarations")
endif()

enable_testing()

# Options to relax hard dependencies and allow callers to tweak behavior
option(SYSIO_TESTER_REQUIRE_LLVM "Require LLVM to be present" OFF)
set(SYSIO_TESTER_BOOST_MIN_VERSION "1.70" CACHE STRING "Minimum Boost version to accept")
set(SYSIO_TESTER_EXTRA_INCLUDE_DIRS "" CACHE PATH "Extra include dirs for Sysio tests")

# LLVM (optional)
if(SYSIO_TESTER_REQUIRE_LLVM OR DEFINED LLVM_DIR)
    if(LLVM_DIR STREQUAL "" OR NOT LLVM_DIR)
        set(LLVM_DIR @LLVM_DIR@)
    endif()
    if(LLVM_DIR)
        find_package(LLVM QUIET CONFIG)
        if(LLVM_FOUND)
            llvm_map_components_to_libnames(LLVM_LIBS support core passes mcjit native DebugInfoDWARF orcjit)
        endif()
    endif()
endif()

# Threads and libatomic fallback
set(CMAKE_THREAD_PREFER_PTHREAD TRUE)
set(THREADS_PREFER_PTHREAD_FLAG TRUE)
find_package(Threads REQUIRED)
find_library(SYSIO_TESTER_ATOMIC_LIB atomic)
set(SYSIO_TESTER_ATOMIC_LINK "")
if(SYSIO_TESTER_ATOMIC_LIB)
    set(SYSIO_TESTER_ATOMIC_LINK ${SYSIO_TESTER_ATOMIC_LIB})
else()
    # Fall back to linking by name; harmless if not needed/available
    set(SYSIO_TESTER_ATOMIC_LINK atomic)
endif()

# CALCULATE PATHS
get_filename_component(sysioPrefixDir ${CMAKE_CURRENT_LIST_DIR}/../../.. ABSOLUTE)
set(sysioLibDir ${sysioPrefixDir}/lib)
set(sysioLibCmakeDir ${sysioLibDir}/cmake)
set(sysioIncludeDir ${sysioPrefixDir}/include)

# SET PREFIX PATHS FOR CMAKE PACKAGES
list(APPEND CMAKE_PREFIX_PATH "${sysioPrefixDir}" "${sysioLibDir}" "${sysioLibCmakeDir}")

# Helper macro to find sysio-provided libraries from ${sysioLibDir}
option(SYSIO_TESTER_ALLOW_EXTRA_LIBRARY_DIRS "Allow adding extra library search paths for SysioTester" ON)
set(SYSIO_TESTER_EXTRA_LIBRARY_DIRS "" CACHE PATH "Extra library directories to help SysioTester locate libs (build-tree)" )

macro(find_sysio_library VAR)
    cmake_parse_arguments(_FSL "" "" "NAMES" ${ARGN})
    if(NOT _FSL_NAMES)
        message(FATAL_ERROR "find_sysio_library(<var> NAMES <names...>) requires NAMES.")
    endif()
    if(SYSIO_TESTER_ALLOW_EXTRA_LIBRARY_DIRS AND SYSIO_TESTER_EXTRA_LIBRARY_DIRS)
        find_library(${VAR} NAMES ${_FSL_NAMES}
                PATHS ${sysioLibDir} ${SYSIO_TESTER_EXTRA_LIBRARY_DIRS}
                NO_DEFAULT_PATH REQUIRED)
    else()
        find_library(${VAR} NAMES ${_FSL_NAMES} PATHS ${sysioLibDir} NO_DEFAULT_PATH REQUIRED)
    endif()
endmacro()

# Boost: robust discovery with fallback to synthesize imported targets
# Allow callers to extend/override components by predefining SYSIO_TESTER_BOOST_COMPONENTS
set(_sysio_boost_components_all
        date_time filesystem system chrono iostreams unit_test_framework
        # header-only components below; do not request them from find_package to avoid warnings
        multi_index multiprecision interprocess asio signals2)
if(NOT DEFINED SYSIO_TESTER_BOOST_COMPONENTS)
    set(SYSIO_TESTER_BOOST_COMPONENTS ${_sysio_boost_components_all})
endif()

# Split compiled and header-only components: only request compiled ones from find_package to avoid warnings
set(_sysio_boost_compiled_components date_time filesystem system chrono iostreams unit_test_framework)

# First try CONFIG mode (vcpkg-style), then fallback to module mode
set(_boost_found FALSE)
# Suppress the noisy "New Boost version" warning
set(Boost_NO_WARN_NEW_VERSIONS ON)
find_package(Boost ${SYSIO_TESTER_BOOST_MIN_VERSION} QUIET CONFIG
        COMPONENTS ${_sysio_boost_compiled_components})
if(Boost_FOUND)
    set(_boost_found TRUE)
else()
    # Module mode fallback
    find_package(Boost ${SYSIO_TESTER_BOOST_MIN_VERSION} QUIET
            COMPONENTS ${_sysio_boost_compiled_components})
    if(Boost_FOUND)
        set(_boost_found TRUE)
    endif()
endif()

# Ensure include dirs are available if Boost was found in any mode
if(_boost_found AND Boost_INCLUDE_DIRS)
    include_directories(${Boost_INCLUDE_DIRS})
endif()

# Synthesize missing imported targets as INTERFACE for any referenced components
foreach(_bcomp IN LISTS SYSIO_TESTER_BOOST_COMPONENTS)
    if(NOT TARGET Boost::${_bcomp})
        add_library(Boost::${_bcomp} INTERFACE IMPORTED)
    endif()
endforeach()

# Gperftools (optional)
find_package(Gperftools QUIET)
if(GPERFTOOLS_FOUND)
    message(STATUS "Found gperftools; compiling tests with TCMalloc")
    list(APPEND PLATFORM_SPECIFIC_LIBS tcmalloc)
endif()

# Sysio libraries (deduplicated via macro)
find_sysio_library(libtester NAMES libsysio_testing sysio_testing)
find_sysio_library(libchain NAMES libsysio_chain sysio_chain)
find_sysio_library(libfc NAMES libfc fc)
find_sysio_library(libwasm NAMES libwasm libWASM WASM)
find_sysio_library(libwast NAMES libwast libWAST WAST)
find_sysio_library(libir NAMES libir libIR IR)
find_sysio_library(liblogging NAMES liblogging libLogging Logging)
find_sysio_library(libchainbase NAMES libchainbase chainbase)
find_sysio_library(libbuiltins NAMES libbuiltins builtins)
find_sysio_library(libsecp256k1 NAMES libsecp256k1 libsecp256k1-internal secp256k1 secp256k1-internal)
find_sysio_library(libbn256 NAMES libbn256 bn256)
find_sysio_library(libbls12-381 NAMES libbls12-381 bls12-381)
find_sysio_library(libsoftfloat NAMES libsoftfloat softfloat)
find_sysio_library(libbscrypto NAMES libbscrypto bscrypto)
find_sysio_library(libdecrepit NAMES libdecrepit decrepit)
find_sysio_library(libsodium NAMES libsodium sodium)
find_sysio_library(libgmp NAMES libgmp gmp)

set(SYSIO_WASM_RUNTIMES @SYSIO_WASM_RUNTIMES@)
set(WRAP_MAIN "")
if("sys-vm-oc" IN_LIST SYSIO_WASM_RUNTIMES)
    set(WRAP_MAIN "-Wl,-wrap=main")
endif()

add_library(SysioChain INTERFACE)

target_link_libraries(SysioChain INTERFACE
        ${libchain}
        ${libfc}
        ${libwast}
        ${libwasm}
        ${libir}
        ${liblogging}
        ${libchainbase}
        ${libbuiltins}
        ${libsecp256k1}
        ${libbn256}
        ${libbls12-381}
        ${libsodium}
        ${libgmp}
        ${libsoftfloat}
        ${libbscrypto}
        ${libdecrepit}

        Boost::date_time
        Boost::filesystem
        Boost::system
        Boost::chrono
        Boost::multi_index
        Boost::multiprecision
        Boost::interprocess
        Boost::asio
        Boost::signals2
        Boost::iostreams

        # Needed by Boost iostreams
        -lz

        ${LLVM_LIBS}
        ${PLATFORM_SPECIFIC_LIBS}
        ${WRAP_MAIN}
        Threads::Threads
        ${SYSIO_TESTER_ATOMIC_LINK}
)

target_include_directories(SysioChain INTERFACE
        ${sysioIncludeDir}
        ${SYSIO_TESTER_EXTRA_INCLUDE_DIRS}
        @OPENSSL_INCLUDE_DIR@
        @CMAKE_INSTALL_PREFIX@
        @CMAKE_INSTALL_FULL_INCLUDEDIR@
        @CMAKE_INSTALL_FULL_INCLUDEDIR@/wasm-jit
        @CMAKE_INSTALL_FULL_INCLUDEDIR@/softfloat)

add_library(SysioTester INTERFACE)

target_link_libraries(SysioTester INTERFACE
        ${libtester}
        Boost::unit_test_framework
        SysioChain
)

macro(add_sysio_test_executable test_name)
    add_executable(${test_name} ${ARGN})
    target_link_libraries(${test_name} SysioTester)
endmacro()

macro(add_sysio_test test_name)
    add_sysio_test_executable(${test_name} ${ARGN})
    #This will generate a test with the default runtime
    add_test(NAME ${test_name} COMMAND ${test_name} --report_level=detailed --color_output)
    #Manually run unit_test for all supported runtimes
    #To run unit_test with all log from blockchain displayed, put --verbose after --, i.e. unit_test -- --verbose
endmacro()

\doxysection{delegate\+\_\+bandwidth.\+cpp}
\hypertarget{delegate__bandwidth_8cpp_source}{}\label{delegate__bandwidth_8cpp_source}\index{/Users/svetlasyrimis/Desktop/wire-\/network/WN-\/org/wire-\/system-\/contracts/contracts/sysio.system/src/delegate\_bandwidth.cpp@{/Users/svetlasyrimis/Desktop/wire-\/network/WN-\/org/wire-\/system-\/contracts/contracts/sysio.system/src/delegate\_bandwidth.cpp}}
\mbox{\hyperlink{delegate__bandwidth_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00001}00001\ \textcolor{preprocessor}{\#include\ <sysio/datastream.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00002}00002\ \textcolor{preprocessor}{\#include\ <sysio/sysio.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00003}00003\ \textcolor{preprocessor}{\#include\ <sysio/multi\_index.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00004}00004\ \textcolor{preprocessor}{\#include\ <sysio/privileged.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00005}00005\ \textcolor{preprocessor}{\#include\ <sysio/serialize.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00006}00006\ \textcolor{preprocessor}{\#include\ <sysio/transaction.hpp>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00008}00008\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{sysio_8system_8hpp}{sysio.system/sysio.system.hpp}}>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00009}00009\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{sysio_8token_8hpp}{sysio.token/sysio.token.hpp}}>}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00011}00011\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacesysiosystem}{sysiosystem}}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00013}00013\ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{structsysio_1_1chain_1_1asset}{sysio::asset}};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00014}00014\ \ \ \ \textcolor{keyword}{using\ }sysio::const\_mem\_fun;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00015}00015\ \ \ \ \textcolor{keyword}{using\ }sysio::current\_time\_point;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00016}00016\ \ \ \ \textcolor{keyword}{using\ }sysio::indexed\_by;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00017}00017\ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{structsysio_1_1chain_1_1permission__level}{sysio::permission\_level}};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00018}00018\ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespacefc_a9623b8cae3f48bbed6aa1fc2afe9b174}{sysio::seconds}};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00019}00019\ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classfc_1_1time__point__sec}{sysio::time\_point\_sec}};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00020}00020\ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classsysio_1_1token}{sysio::token}};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00025}\mbox{\hyperlink{classsysiosystem_1_1system__contract_a4d11e77e985155ccc97fcdb4eaed04af}{00025}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a4d11e77e985155ccc97fcdb4eaed04af}{system\_contract::buyrambytes}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ payer,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ receiver,\ \mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ bytes\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00026}00026\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ itr\ =\ \_rammarket.find(\mbox{\hyperlink{classsysiosystem_1_1system__contract_aaf51c97fb85ab719cf2784e6a3a461e8}{ramcore\_symbol}}.raw());}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00027}00027\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ ram\_reserve\ \ \ =\ itr-\/>base.balance.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00028}00028\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ eos\_reserve\ \ \ =\ itr-\/>quote.balance.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00029}00029\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ cost\ \ \ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{structsysiosystem_1_1exchange__state_a0883f2b115c93fa4f90dc34ebb99992c}{exchange\_state::get\_bancor\_input}}(\ ram\_reserve,\ eos\_reserve,\ bytes\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00030}00030\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ cost\_plus\_fee\ =\ cost\ /\ double(0.995);}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00031}00031\ \ \ \ \ \ \ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a483003285d9c2ad69500c635ac6b5575}{buyram}}(\ payer,\ receiver,\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\{\ cost\_plus\_fee,\ core\_symbol()\ \}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00032}00032\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00043}\mbox{\hyperlink{classsysiosystem_1_1system__contract_a483003285d9c2ad69500c635ac6b5575}{00043}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a483003285d9c2ad69500c635ac6b5575}{system\_contract::buyram}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ payer,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ receiver,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\&\ quant\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00044}00044\ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00045}00045\ \ \ \ \ \ \ require\_auth(\ payer\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00046}00046\ \ \ \ \ \ \ update\_ram\_supply();}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00048}00048\ \ \ \ \ \ \ check(\ quant.symbol\ ==\ core\_symbol(),\ \textcolor{stringliteral}{"{}must\ buy\ ram\ with\ core\ token"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00049}00049\ \ \ \ \ \ \ check(\ quant.amount\ >\ 0,\ \textcolor{stringliteral}{"{}must\ purchase\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00050}00050\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00051}00051\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fee\ =\ quant;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00052}00052\ \ \ \ \ \ \ fee.amount\ =\ (\ fee.amount\ +\ 199\ )\ /\ 200;\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00053}00053\ \ \ \ \ \ \ \textcolor{comment}{//\ fee.amount\ cannot\ be\ 0\ since\ that\ is\ only\ possible\ if\ quant.amount\ is\ 0\ which\ is\ not\ allowed\ by\ the\ assert\ above.}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00054}00054\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ quant.amount\ ==\ 1,\ then\ fee.amount\ ==\ 1,}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00055}00055\ \ \ \ \ \ \ \textcolor{comment}{//\ otherwise\ if\ quant.amount\ >\ 1,\ then\ 0\ <\ fee.amount\ <\ quant.amount.}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00056}00056\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ quant\_after\_fee\ =\ quant;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00057}00057\ \ \ \ \ \ \ quant\_after\_fee.amount\ -\/=\ fee.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00058}00058\ \ \ \ \ \ \ \textcolor{comment}{//\ quant\_after\_fee.amount\ should\ be\ >\ 0\ if\ quant.amount\ >\ 1.}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00059}00059\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ quant.amount\ ==\ 1,\ then\ quant\_after\_fee.amount\ ==\ 0\ and\ the\ next\ inline\ transfer\ will\ fail\ causing\ the\ buyram\ action\ to\ fail.}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00060}00060\ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00061}00061\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{payer,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\},\ \{\mbox{\hyperlink{classsysiosystem_1_1system__contract_a0add35d040035e4586d91e37c3725e96}{ram\_account}},\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00062}00062\ \ \ \ \ \ \ \ \ \ transfer\_act.send(\ payer,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a0add35d040035e4586d91e37c3725e96}{ram\_account}},\ quant\_after\_fee,\ \textcolor{stringliteral}{"{}buy\ ram"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00063}00063\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00064}00064\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ fee.amount\ >\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00065}00065\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{payer,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00066}00066\ \ \ \ \ \ \ \ \ \ transfer\_act.send(\ payer,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_abd58f4313ff80215fbf8d9111755d8a8}{ramfee\_account}},\ fee,\ \textcolor{stringliteral}{"{}ram\ fee"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00067}00067\ \ \ \ \ \ \ \ \ \ channel\_to\_rex(\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_abd58f4313ff80215fbf8d9111755d8a8}{ramfee\_account}},\ fee\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00068}00068\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00069}00069\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00070}00070\ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ bytes\_out;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00071}00071\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00072}00072\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ market\ =\ \_rammarket.get(\mbox{\hyperlink{classsysiosystem_1_1system__contract_aaf51c97fb85ab719cf2784e6a3a461e8}{ramcore\_symbol}}.raw(),\ \textcolor{stringliteral}{"{}ram\ market\ does\ not\ exist"{}});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00073}00073\ \ \ \ \ \ \ \_rammarket.modify(\ market,\ same\_payer,\ [\&](\ \textcolor{keyword}{auto}\&\ es\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00074}00074\ \ \ \ \ \ \ \ \ \ bytes\_out\ =\ es.direct\_convert(\ quant\_after\_fee,\ \ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a4460aab48cb8c446fe98370466042b15}{ram\_symbol}}\ ).amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00075}00075\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00077}00077\ \ \ \ \ \ \ check(\ bytes\_out\ >\ 0,\ \textcolor{stringliteral}{"{}must\ reserve\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00078}00078\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00079}00079\ \ \ \ \ \ \ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a8c5f9cdc80707168acf0eaaa6f71561e}{total\_ram\_bytes\_reserved}}\ +=\ \mbox{\hyperlink{stdint_8h_aec6fcb673ff035718c238c8c9d544c47}{uint64\_t}}(bytes\_out);}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00080}00080\ \ \ \ \ \ \ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a58a493f1e79c4ac6039d90fa67acc8e2}{total\_ram\_stake}}\ \ \ \ \ \ \ \ \ \ +=\ quant\_after\_fee.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00082}00082\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_aeda3aa12065ee04f138f8538184b8e54}{user\_resources\_table}}\ \ userres(\ get\_self(),\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00083}00083\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ res\_itr\ =\ userres.find(\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00084}00084\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ res\_itr\ ==\ \ userres.end()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00085}00085\ \ \ \ \ \ \ \ \ \ res\_itr\ =\ userres.emplace(\ receiver,\ [\&](\ \textcolor{keyword}{auto}\&\ res\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00086}00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ res.owner\ =\ receiver;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00087}00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ res.net\_weight\ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00088}00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ res.cpu\_weight\ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00089}00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ res.ram\_bytes\ =\ bytes\_out;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00091}00091\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00092}00092\ \ \ \ \ \ \ \ \ \ userres.modify(\ res\_itr,\ receiver,\ [\&](\ \textcolor{keyword}{auto}\&\ res\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ res.ram\_bytes\ +=\ bytes\_out;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00094}00094\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00095}00095\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00096}00096\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00097}00097\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ voter\_itr\ =\ \_voters.find(\ res\_itr-\/>owner.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00098}00098\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\_itr\ ==\ \_voters.end()\ ||\ !has\_field(\ voter\_itr-\/>flags1,\ \mbox{\hyperlink{structsysiosystem_1_1voter__info_a327be7d8d01a553dfe29535d56828576ae149b497807ee78e9e5180d213e5a402}{voter\_info::flags1\_fields::ram\_managed}}\ )\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ ram\_bytes,\ net,\ cpu;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00100}00100\ \ \ \ \ \ \ \ \ \ get\_resource\_limits(\ res\_itr-\/>owner,\ ram\_bytes,\ net,\ cpu\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00101}00101\ \ \ \ \ \ \ \ \ \ set\_resource\_limits(\ res\_itr-\/>owner,\ res\_itr-\/>ram\_bytes\ +\ ram\_gift\_bytes,\ net,\ cpu\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00102}00102\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00103}00103\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00111}\mbox{\hyperlink{classsysiosystem_1_1system__contract_ad0bd974e5cf148c501e43661338403e1}{00111}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_ad0bd974e5cf148c501e43661338403e1}{system\_contract::sellram}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ account,\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ bytes\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00112}00112\ \ \ \ \ \ \ require\_auth(\ account\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00113}00113\ \ \ \ \ \ \ update\_ram\_supply();}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00114}00114\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00115}00115\ \ \ \ \ \ \ check(\ bytes\ >\ 0,\ \textcolor{stringliteral}{"{}cannot\ sell\ negative\ byte"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00116}00116\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00117}00117\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_aeda3aa12065ee04f138f8538184b8e54}{user\_resources\_table}}\ \ userres(\ get\_self(),\ account.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00118}00118\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ res\_itr\ =\ userres.find(\ account.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00119}00119\ \ \ \ \ \ \ check(\ res\_itr\ !=\ userres.end(),\ \textcolor{stringliteral}{"{}no\ resource\ row"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00120}00120\ \ \ \ \ \ \ check(\ res\_itr-\/>ram\_bytes\ >=\ bytes,\ \textcolor{stringliteral}{"{}insufficient\ quota"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00121}00121\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00122}00122\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\ tokens\_out;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00123}00123\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ itr\ =\ \_rammarket.find(\mbox{\hyperlink{classsysiosystem_1_1system__contract_aaf51c97fb85ab719cf2784e6a3a461e8}{ramcore\_symbol}}.raw());}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00124}00124\ \ \ \ \ \ \ \_rammarket.modify(\ itr,\ same\_payer,\ [\&](\ \textcolor{keyword}{auto}\&\ es\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00126}00126\ \ \ \ \ \ \ \ \ \ tokens\_out\ =\ es.direct\_convert(\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(bytes,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a4460aab48cb8c446fe98370466042b15}{ram\_symbol}}),\ core\_symbol());}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00127}00127\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00128}00128\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00129}00129\ \ \ \ \ \ \ check(\ tokens\_out.amount\ >\ 1,\ \textcolor{stringliteral}{"{}token\ amount\ received\ from\ selling\ ram\ is\ too\ low"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00130}00130\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00131}00131\ \ \ \ \ \ \ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a8c5f9cdc80707168acf0eaaa6f71561e}{total\_ram\_bytes\_reserved}}\ -\/=\ \textcolor{keyword}{static\_cast<}decltype(\_gstate.total\_ram\_bytes\_reserved)\textcolor{keyword}{>}(bytes);\ \textcolor{comment}{//\ bytes\ >\ 0\ is\ asserted\ above}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00132}00132\ \ \ \ \ \ \ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a58a493f1e79c4ac6039d90fa67acc8e2}{total\_ram\_stake}}\ \ \ \ \ \ \ \ \ \ -\/=\ tokens\_out.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00133}00133\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00135}00135\ \ \ \ \ \ \ check(\ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a58a493f1e79c4ac6039d90fa67acc8e2}{total\_ram\_stake}}\ >=\ 0,\ \textcolor{stringliteral}{"{}error,\ attempt\ to\ unstake\ more\ tokens\ than\ previously\ staked"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00136}00136\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00137}00137\ \ \ \ \ \ \ userres.modify(\ res\_itr,\ account,\ [\&](\ \textcolor{keyword}{auto}\&\ res\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ res.ram\_bytes\ -\/=\ bytes;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00139}00139\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00140}00140\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00141}00141\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ voter\_itr\ =\ \_voters.find(\ res\_itr-\/>owner.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00142}00142\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\_itr\ ==\ \_voters.end()\ ||\ !has\_field(\ voter\_itr-\/>flags1,\ \mbox{\hyperlink{structsysiosystem_1_1voter__info_a327be7d8d01a553dfe29535d56828576ae149b497807ee78e9e5180d213e5a402}{voter\_info::flags1\_fields::ram\_managed}}\ )\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ ram\_bytes,\ net,\ cpu;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00144}00144\ \ \ \ \ \ \ \ \ \ get\_resource\_limits(\ res\_itr-\/>owner,\ ram\_bytes,\ net,\ cpu\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00145}00145\ \ \ \ \ \ \ \ \ \ set\_resource\_limits(\ res\_itr-\/>owner,\ res\_itr-\/>ram\_bytes\ +\ ram\_gift\_bytes,\ net,\ cpu\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00146}00146\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00147}00147\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00148}00148\ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{\mbox{\hyperlink{classsysiosystem_1_1system__contract_a0add35d040035e4586d91e37c3725e96}{ram\_account}},\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\},\ \{account,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00150}00150\ \ \ \ \ \ \ \ \ \ transfer\_act.send(\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a0add35d040035e4586d91e37c3725e96}{ram\_account}},\ account,\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(tokens\_out),\ \textcolor{stringliteral}{"{}sell\ ram"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00151}00151\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00152}00152\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fee\ =\ (\ tokens\_out.amount\ +\ 199\ )\ /\ 200;\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00153}00153\ \ \ \ \ \ \ \textcolor{comment}{//\ since\ tokens\_out.amount\ was\ asserted\ to\ be\ at\ least\ 2\ earlier,\ fee.amount\ <\ tokens\_out.amount}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00154}00154\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ fee\ >\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{account,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00156}00156\ \ \ \ \ \ \ \ \ \ transfer\_act.send(\ account,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_abd58f4313ff80215fbf8d9111755d8a8}{ramfee\_account}},\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(fee,\ core\_symbol()),\ \textcolor{stringliteral}{"{}sell\ ram\ fee"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00157}00157\ \ \ \ \ \ \ \ \ \ channel\_to\_rex(\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_abd58f4313ff80215fbf8d9111755d8a8}{ramfee\_account}},\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}(fee,\ core\_symbol()\ ));}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00158}00158\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00159}00159\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00160}00160\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00161}\mbox{\hyperlink{namespacesysiosystem_aed36584da36967a186e611f01af041cc}{00161}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacesysiosystem_aed36584da36967a186e611f01af041cc}{validate\_b1\_vesting}}(\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ stake\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00162}00162\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ base\_time\ =\ 1527811200;\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00163}00163\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ current\_time\ =\ 1638921540;\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00164}00164\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ max\_claimable\ =\ 100'000'000'0000ll;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00165}00165\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ claimable\ =\ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}(max\_claimable\ *\ \textcolor{keywordtype}{double}(current\_time\ -\/\ base\_time)\ /\ (10*seconds\_per\_year)\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00166}00166\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00167}00167\ \ \ \ \ \ \ check(\ max\_claimable\ -\/\ claimable\ <=\ stake,\ \textcolor{stringliteral}{"{}b1\ can\ only\ claim\ their\ tokens\ over\ 10\ years"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00168}00168\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00169}00169\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00170}00170\ \ \ \ \textcolor{keywordtype}{void}\ system\_contract::changebw(\ \mbox{\hyperlink{catch__reporter__console_8cpp_a9b45b3e13bd9167aab02e17e08916231}{name}}\ from,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{catch__reporter__console_8cpp_a9b45b3e13bd9167aab02e17e08916231}{name}}\&\ receiver,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ asset\&\ stake\_net\_delta,\ \textcolor{keyword}{const}\ asset\&\ stake\_cpu\_delta,\ \textcolor{keywordtype}{bool}\ transfer\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00172}00172\ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00173}00173\ \ \ \ \ \ \ require\_auth(\ from\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00174}00174\ \ \ \ \ \ \ check(\ stake\_net\_delta.amount\ !=\ 0\ ||\ stake\_cpu\_delta.amount\ !=\ 0,\ \textcolor{stringliteral}{"{}should\ stake\ non-\/zero\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00175}00175\ \ \ \ \ \ \ check(\ std::abs(\ (stake\_net\_delta\ +\ stake\_cpu\_delta).amount\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ >=\ std::max(\ std::abs(\ stake\_net\_delta.amount\ ),\ std::abs(\ stake\_cpu\_delta.amount\ )\ ),}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00177}00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}net\ and\ cpu\ deltas\ cannot\ be\ opposite\ signs"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00178}00178\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00179}00179\ \ \ \ \ \ \ \mbox{\hyperlink{catch__reporter__console_8cpp_a9b45b3e13bd9167aab02e17e08916231}{name}}\ source\_stake\_from\ =\ from;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00180}00180\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ transfer\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00181}00181\ \ \ \ \ \ \ \ \ \ from\ =\ receiver;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00182}00182\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00183}00183\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00184}00184\ \ \ \ \ \ \ \textcolor{comment}{//\ update\ stake\ delegated\ from\ "{}from"{}\ to\ "{}receiver"{}}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00185}00185\ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00186}00186\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_a205c7938369bd90edc20122ae99826be}{del\_bandwidth\_table}}\ \ \ \ \ del\_tbl(\ get\_self(),\ from.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ itr\ =\ del\_tbl.find(\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00188}00188\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ itr\ ==\ del\_tbl.end()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00189}00189\ \ \ \ \ \ \ \ \ \ \ \ \ itr\ =\ del\_tbl.emplace(\ from,\ [\&](\ \textcolor{keyword}{auto}\&\ dbo\ )\{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00190}00190\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.from\ \ \ \ \ \ \ \ \ \ =\ from;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00191}00191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.to\ \ \ \ \ \ \ \ \ \ \ \ =\ receiver;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00192}00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.net\_weight\ \ \ \ =\ stake\_net\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00193}00193\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.cpu\_weight\ \ \ \ =\ stake\_cpu\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00194}00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00195}00195\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ del\_tbl.modify(\ itr,\ same\_payer,\ [\&](\ \textcolor{keyword}{auto}\&\ dbo\ )\{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.net\_weight\ \ \ \ +=\ stake\_net\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00199}00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dbo.cpu\_weight\ \ \ \ +=\ stake\_cpu\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00202}00202\ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ itr-\/>net\_weight.amount,\ \textcolor{stringliteral}{"{}insufficient\ staked\ net\ bandwidth"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00203}00203\ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ itr-\/>cpu\_weight.amount,\ \textcolor{stringliteral}{"{}insufficient\ staked\ cpu\ bandwidth"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00204}00204\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ itr-\/>is\_empty()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ del\_tbl.erase(\ itr\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00207}00207\ \ \ \ \ \ \ \}\ \textcolor{comment}{//\ itr\ can\ be\ invalid,\ should\ go\ out\ of\ scope}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00208}00208\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00209}00209\ \ \ \ \ \ \ \textcolor{comment}{//\ update\ totals\ of\ "{}receiver"{}}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00210}00210\ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00211}00211\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_aeda3aa12065ee04f138f8538184b8e54}{user\_resources\_table}}\ \ \ totals\_tbl(\ get\_self(),\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00212}00212\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tot\_itr\ =\ totals\_tbl.find(\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00213}00213\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ tot\_itr\ ==\ \ totals\_tbl.end()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ tot\_itr\ =\ totals\_tbl.emplace(\ from,\ [\&](\ \textcolor{keyword}{auto}\&\ tot\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tot.owner\ =\ receiver;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tot.net\_weight\ \ \ \ =\ stake\_net\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tot.cpu\_weight\ \ \ \ =\ stake\_cpu\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00218}00218\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00219}00219\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00220}00220\ \ \ \ \ \ \ \ \ \ \ \ \ totals\_tbl.modify(\ tot\_itr,\ from\ ==\ receiver\ ?\ from\ :\ same\_payer,\ [\&](\ \textcolor{keyword}{auto}\&\ tot\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00221}00221\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tot.net\_weight\ \ \ \ +=\ stake\_net\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tot.cpu\_weight\ \ \ \ +=\ stake\_cpu\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00223}00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00224}00224\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00225}00225\ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ tot\_itr-\/>net\_weight.amount,\ \textcolor{stringliteral}{"{}insufficient\ staked\ total\ net\ bandwidth"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00226}00226\ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ tot\_itr-\/>cpu\_weight.amount,\ \textcolor{stringliteral}{"{}insufficient\ staked\ total\ cpu\ bandwidth"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00227}00227\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ ram\_managed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00230}00230\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ net\_managed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00231}00231\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ cpu\_managed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00232}00232\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00233}00233\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ voter\_itr\ =\ \_voters.find(\ receiver.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00234}00234\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\_itr\ !=\ \_voters.end()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ram\_managed\ =\ has\_field(\ voter\_itr-\/>flags1,\ \mbox{\hyperlink{structsysiosystem_1_1voter__info_a327be7d8d01a553dfe29535d56828576ae149b497807ee78e9e5180d213e5a402}{voter\_info::flags1\_fields::ram\_managed}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ net\_managed\ =\ has\_field(\ voter\_itr-\/>flags1,\ \mbox{\hyperlink{structsysiosystem_1_1voter__info_a327be7d8d01a553dfe29535d56828576a944559ad694d4c0fc4bf286864caf2a2}{voter\_info::flags1\_fields::net\_managed}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00237}00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cpu\_managed\ =\ has\_field(\ voter\_itr-\/>flags1,\ \mbox{\hyperlink{structsysiosystem_1_1voter__info_a327be7d8d01a553dfe29535d56828576ace319c6a1aa0ced6ea5a02270d863f4c}{voter\_info::flags1\_fields::cpu\_managed}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00238}00238\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00239}00239\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00240}00240\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ !(net\_managed\ \&\&\ cpu\_managed)\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00241}00241\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a414156feea104f8f75b4ed9e3121b2f6}{int64\_t}}\ ram\_bytes,\ net,\ cpu;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00242}00242\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_resource\_limits(\ receiver,\ ram\_bytes,\ net,\ cpu\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00243}00243\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00244}00244\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ set\_resource\_limits(\ receiver,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00245}00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ram\_managed\ ?\ ram\_bytes\ :\ std::max(\ tot\_itr-\/>ram\_bytes\ +\ ram\_gift\_bytes,\ ram\_bytes\ ),}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ net\_managed\ ?\ net\ :\ tot\_itr-\/>net\_weight.amount,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00247}00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cpu\_managed\ ?\ cpu\ :\ tot\_itr-\/>cpu\_weight.amount\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00248}00248\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00249}00249\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00250}00250\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00251}00251\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ tot\_itr-\/>is\_empty()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00252}00252\ \ \ \ \ \ \ \ \ \ \ \ \ totals\_tbl.erase(\ tot\_itr\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00253}00253\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00254}00254\ \ \ \ \ \ \ \}\ \textcolor{comment}{//\ tot\_itr\ can\ be\ invalid,\ should\ go\ out\ of\ scope}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00255}00255\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00256}00256\ \ \ \ \ \ \ \textcolor{comment}{//\ create\ refund\ or\ update\ from\ existing\ refund}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00257}00257\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a525a6755d63c4960add11c952b00548f}{stake\_account}}\ !=\ source\_stake\_from\ )\ \{\ \textcolor{comment}{//for\ sysio\ both\ transfer\ and\ refund\ make\ no\ sense}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00258}00258\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_a26c6e658ca5a182ea69d27bab1cc74a4}{refunds\_table}}\ refunds\_tbl(\ get\_self(),\ from.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00259}00259\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ req\ =\ refunds\_tbl.find(\ from.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00260}00260\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00261}00261\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//create/update/delete\ refund}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00262}00262\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ net\_balance\ =\ stake\_net\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00263}00263\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ cpu\_balance\ =\ stake\_cpu\_delta;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00264}00264\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ need\_deferred\_trx\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00265}00265\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00266}00266\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00267}00267\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ net\ and\ cpu\ are\ same\ sign\ by\ assertions\ in\ delegatebw\ and\ undelegatebw}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00268}00268\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ redundant\ assertion\ also\ at\ start\ of\ changebw\ to\ protect\ against\ misuse\ of\ changebw}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00269}00269\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_undelegating\ =\ (net\_balance.amount\ +\ cpu\_balance.amount\ )\ <\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00270}00270\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_delegating\_to\_self\ =\ (!transfer\ \&\&\ from\ ==\ receiver);}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00271}00271\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00272}00272\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ is\_delegating\_to\_self\ ||\ is\_undelegating\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00273}00273\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ req\ !=\ refunds\_tbl.end()\ )\ \{\ \textcolor{comment}{//need\ to\ update\ refund}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00274}00274\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ refunds\_tbl.modify(\ req,\ same\_payer,\ [\&](\ refund\_request\&\ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00275}00275\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ net\_balance.amount\ <\ 0\ ||\ cpu\_balance.amount\ <\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00276}00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.request\_time\ =\ current\_time\_point();}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00277}00277\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00278}00278\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount\ -\/=\ net\_balance;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00279}00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount.amount\ <\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00280}00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ net\_balance\ =\ -\/\mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00281}00281\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00283}00283\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ net\_balance.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00284}00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00285}00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount\ -\/=\ cpu\_balance;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00286}00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount.amount\ <\ 0\ )\{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00287}00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cpu\_balance\ =\ -\/\mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00288}00288\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00289}00289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00290}00290\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cpu\_balance.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00291}00291\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00292}00292\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00293}00293\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00294}00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ req-\/>net\_amount.amount,\ \textcolor{stringliteral}{"{}negative\ net\ refund\ amount"{}}\ );\ \textcolor{comment}{//should\ never\ happen}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00295}00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ check(\ 0\ <=\ req-\/>cpu\_amount.amount,\ \textcolor{stringliteral}{"{}negative\ cpu\ refund\ amount"{}}\ );\ \textcolor{comment}{//should\ never\ happen}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00296}00296\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00297}00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ req-\/>is\_empty()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00298}00298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ refunds\_tbl.erase(\ req\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00299}00299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ need\_deferred\_trx\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00300}00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00301}00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ need\_deferred\_trx\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00302}00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00303}00303\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\ net\_balance.amount\ <\ 0\ ||\ cpu\_balance.amount\ <\ 0\ )\ \{\ \textcolor{comment}{//need\ to\ create\ refund}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00304}00304\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ refunds\_tbl.emplace(\ from,\ [\&](\ refund\_request\&\ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00305}00305\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.owner\ =\ from;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00306}00306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ net\_balance.amount\ <\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00307}00307\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount\ =\ -\/net\_balance;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00308}00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ net\_balance.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00309}00309\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00310}00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.net\_amount\ =\ asset(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00311}00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00312}00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ cpu\_balance.amount\ <\ 0\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00313}00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount\ =\ -\/cpu\_balance;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00314}00314\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cpu\_balance.amount\ =\ 0;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00315}00315\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00316}00316\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.cpu\_amount\ =\ asset(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00317}00317\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00318}00318\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_af0a5201ca8846f05f25435b41d7f39f7}{r}}.request\_time\ =\ current\_time\_point();}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00319}00319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00320}00320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ need\_deferred\_trx\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00321}00321\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{comment}{//\ else\ stake\ increase\ requested\ with\ no\ existing\ row\ in\ refunds\_tbl\ -\/>\ nothing\ to\ do\ with\ refunds\_tbl}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00322}00322\ \ \ \ \ \ \ \ \ \ \}\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00323}00323\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00324}00324\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ need\_deferred\_trx\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00325}00325\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1chain_1_1transaction}{sysio::transaction}}\ out;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00326}00326\ \ \ \ \ \ \ \ \ \ \ \ \ out.\mbox{\hyperlink{structsysio_1_1chain_1_1transaction_a407fcf1868b81bb30b85f80d388bbac2}{actions}}.emplace\_back(\ permission\_level\{from,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\},}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00327}00327\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_self(),\ \textcolor{stringliteral}{"{}refund"{}}\_n,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00328}00328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ from}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00329}00329\ \ \ \ \ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00330}00330\ \ \ \ \ \ \ \ \ \ \ \ \ out.delay\_sec\ =\ refund\_delay\_sec;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00331}00331\ \ \ \ \ \ \ \ \ \ \ \ \ sysio::cancel\_deferred(\ from.value\ );\ \textcolor{comment}{//\ TODO:\ Remove\ this\ line\ when\ replacing\ deferred\ transactions\ is\ fixed}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00332}00332\ \ \ \ \ \ \ \ \ \ \ \ \ out.send(\ from.value,\ from,\ \textcolor{keyword}{true}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00333}00333\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00334}00334\ \ \ \ \ \ \ \ \ \ \ \ \ sysio::cancel\_deferred(\ from.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00335}00335\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00336}00336\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00337}00337\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ transfer\_amount\ =\ net\_balance\ +\ cpu\_balance;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00338}00338\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ 0\ <\ transfer\_amount.amount\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00339}00339\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{source\_stake\_from,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00340}00340\ \ \ \ \ \ \ \ \ \ \ \ \ transfer\_act.send(\ source\_stake\_from,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a525a6755d63c4960add11c952b00548f}{stake\_account}},\ asset(transfer\_amount),\ \textcolor{stringliteral}{"{}stake\ bandwidth"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00341}00341\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00342}00342\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00343}00343\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00344}00344\ \ \ \ \ \ \ vote\_stake\_updater(\ from\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00345}00345\ \ \ \ \ \ \ update\_voting\_power(\ from,\ stake\_net\_delta\ +\ stake\_cpu\_delta\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00346}00346\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00347}00347\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00348}00348\ \ \ \ \textcolor{keywordtype}{void}\ system\_contract::update\_voting\_power(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{catch__reporter__console_8cpp_a9b45b3e13bd9167aab02e17e08916231}{name}}\&\ voter,\ \textcolor{keyword}{const}\ asset\&\ total\_update\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00349}00349\ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00350}00350\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ voter\_itr\ =\ \_voters.find(\ voter.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00351}00351\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\_itr\ ==\ \_voters.end()\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00352}00352\ \ \ \ \ \ \ \ \ \ voter\_itr\ =\ \_voters.emplace(\ voter,\ [\&](\ \textcolor{keyword}{auto}\&\ v\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00353}00353\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedevelop_build_ade64cd34608f9442ef3049116a2da428}{v}}.owner\ \ =\ voter;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00354}00354\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedevelop_build_ade64cd34608f9442ef3049116a2da428}{v}}.staked\ =\ total\_update.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00355}00355\ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00356}00356\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00357}00357\ \ \ \ \ \ \ \ \ \ \_voters.modify(\ voter\_itr,\ same\_payer,\ [\&](\ \textcolor{keyword}{auto}\&\ v\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00358}00358\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedevelop_build_ade64cd34608f9442ef3049116a2da428}{v}}.staked\ +=\ total\_update.amount;}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00359}00359\ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00360}00360\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00361}00361\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00362}00362\ \ \ \ \ \ \ check(\ 0\ <=\ voter\_itr-\/>staked,\ \textcolor{stringliteral}{"{}stake\ for\ voting\ cannot\ be\ negative"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00363}00363\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00364}00364\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\ ==\ \textcolor{stringliteral}{"{}b1"{}}\_n\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00365}00365\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_aed36584da36967a186e611f01af041cc}{validate\_b1\_vesting}}(\ voter\_itr-\/>staked\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00366}00366\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00367}00367\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00368}00368\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ voter\_itr-\/>producers.size()\ ||\ voter\_itr-\/>proxy\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00369}00369\ \ \ \ \ \ \ \ \ \ update\_votes(\ voter,\ voter\_itr-\/>proxy,\ voter\_itr-\/>producers,\ \textcolor{keyword}{false}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00370}00370\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00371}00371\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00372}00372\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00373}\mbox{\hyperlink{classsysiosystem_1_1system__contract_ad9648128095ae0e0983b4585a23e1fec}{00373}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_ad9648128095ae0e0983b4585a23e1fec}{system\_contract::delegatebw}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ from,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ receiver,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00374}00374\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\&\ stake\_net\_quantity,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00375}00375\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\&\ stake\_cpu\_quantity,\ \textcolor{keywordtype}{bool}\ transfer\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00376}00376\ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00377}00377\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\ zero\_asset(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00378}00378\ \ \ \ \ \ \ check(\ stake\_cpu\_quantity\ >=\ zero\_asset,\ \textcolor{stringliteral}{"{}must\ stake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00379}00379\ \ \ \ \ \ \ check(\ stake\_net\_quantity\ >=\ zero\_asset,\ \textcolor{stringliteral}{"{}must\ stake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00380}00380\ \ \ \ \ \ \ check(\ stake\_net\_quantity.amount\ +\ stake\_cpu\_quantity.amount\ >\ 0,\ \textcolor{stringliteral}{"{}must\ stake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00381}00381\ \ \ \ \ \ \ check(\ !transfer\ ||\ from\ !=\ receiver,\ \textcolor{stringliteral}{"{}cannot\ use\ transfer\ flag\ if\ delegating\ to\ self"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00382}00382\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00383}00383\ \ \ \ \ \ \ changebw(\ from,\ receiver,\ stake\_net\_quantity,\ stake\_cpu\_quantity,\ transfer);}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00384}00384\ \ \ \ \}\ \textcolor{comment}{//\ delegatebw}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00385}00385\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00386}\mbox{\hyperlink{classsysiosystem_1_1system__contract_a8ad67e13dbed5ec9da9a4d1452dae1aa}{00386}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a8ad67e13dbed5ec9da9a4d1452dae1aa}{system\_contract::undelegatebw}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ from,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ receiver,}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00387}00387\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\&\ unstake\_net\_quantity,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\&\ unstake\_cpu\_quantity\ )}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00388}00388\ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00389}00389\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1chain_1_1asset}{asset}}\ zero\_asset(\ 0,\ core\_symbol()\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00390}00390\ \ \ \ \ \ \ check(\ unstake\_cpu\_quantity\ >=\ zero\_asset,\ \textcolor{stringliteral}{"{}must\ unstake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00391}00391\ \ \ \ \ \ \ check(\ unstake\_net\_quantity\ >=\ zero\_asset,\ \textcolor{stringliteral}{"{}must\ unstake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00392}00392\ \ \ \ \ \ \ check(\ unstake\_cpu\_quantity.amount\ +\ unstake\_net\_quantity.amount\ >\ 0,\ \textcolor{stringliteral}{"{}must\ unstake\ a\ positive\ amount"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00393}00393\ \ \ \ \ \ \ check(\ \_gstate.\mbox{\hyperlink{structsysiosystem_1_1sysio__global__state_a9103ca2911e1be3a551b03f6f8d19895}{thresh\_activated\_stake\_time}}\ !=\ \mbox{\hyperlink{classfc_1_1time__point}{time\_point}}(),}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00394}00394\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}cannot\ undelegate\ bandwidth\ until\ the\ chain\ is\ activated\ (at\ least\ 15\%\ of\ all\ tokens\ participate\ in\ voting)"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00395}00395\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00396}00396\ \ \ \ \ \ \ changebw(\ from,\ receiver,\ -\/unstake\_net\_quantity,\ -\/unstake\_cpu\_quantity,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00397}00397\ \ \ \ \}\ \textcolor{comment}{//\ undelegatebw}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00398}00398\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00399}00399\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00400}\mbox{\hyperlink{classsysiosystem_1_1system__contract_a73dec1249b333f6a60867b44237b6f40}{00400}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73dec1249b333f6a60867b44237b6f40}{system\_contract::refund}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsysio_1_1chain_1_1name}{name}}\&\ owner\ )\ \{}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00401}00401\ \ \ \ \ \ \ require\_auth(\ owner\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00402}00402\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00403}00403\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysiosystem_a26c6e658ca5a182ea69d27bab1cc74a4}{refunds\_table}}\ refunds\_tbl(\ get\_self(),\ owner.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00404}00404\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ req\ =\ refunds\_tbl.find(\ owner.value\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00405}00405\ \ \ \ \ \ \ check(\ req\ !=\ refunds\_tbl.end(),\ \textcolor{stringliteral}{"{}refund\ request\ not\ found"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00406}00406\ \ \ \ \ \ \ check(\ req-\/>request\_time\ +\ seconds(refund\_delay\_sec)\ <=\ current\_time\_point(),}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00407}00407\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}refund\ is\ not\ available\ yet"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00408}00408\ \ \ \ \ \ \ \mbox{\hyperlink{classsysio_1_1token_a104313ae127b80733cf26925f5246379}{token::transfer\_action}}\ transfer\_act\{\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a52f7532857765f2a19f0b55e9b8c29ea}{token\_account}},\ \{\ \{\mbox{\hyperlink{classsysiosystem_1_1system__contract_a525a6755d63c4960add11c952b00548f}{stake\_account}},\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\},\ \{req-\/>owner,\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a73d78c07b50de02a172c31966637041e}{active\_permission}}\}\ \}\ \};}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00409}00409\ \ \ \ \ \ \ transfer\_act.send(\ \mbox{\hyperlink{classsysiosystem_1_1system__contract_a525a6755d63c4960add11c952b00548f}{stake\_account}},\ req-\/>owner,\ req-\/>net\_amount\ +\ req-\/>cpu\_amount,\ \textcolor{stringliteral}{"{}unstake"{}}\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00410}00410\ \ \ \ \ \ \ refunds\_tbl.erase(\ req\ );}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00411}00411\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00412}00412\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00413}00413\ }
\DoxyCodeLine{\Hypertarget{delegate__bandwidth_8cpp_source_l00414}00414\ \}\ \textcolor{comment}{//namespace\ sysiosystem}}

\end{DoxyCode}

\doxysection{lib\+\_\+util.\+c}
\hypertarget{lib__util_8c_source}{}\label{lib__util_8c_source}\index{libraries/yubihsm/lib/lib\_util.c@{libraries/yubihsm/lib/lib\_util.c}}
\mbox{\hyperlink{lib__util_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00002}00002\ \textcolor{comment}{\ *\ Copyright\ 2015-\/2018\ Yubico\ AB}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00003}00003\ \textcolor{comment}{\ *}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00004}00004\ \textcolor{comment}{\ *\ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00005}00005\ \textcolor{comment}{\ *\ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00006}00006\ \textcolor{comment}{\ *\ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00007}00007\ \textcolor{comment}{\ *}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00008}00008\ \textcolor{comment}{\ *\ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00009}00009\ \textcolor{comment}{\ *}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00010}00010\ \textcolor{comment}{\ *\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00011}00011\ \textcolor{comment}{\ *\ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00012}00012\ \textcolor{comment}{\ *\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00013}00013\ \textcolor{comment}{\ *\ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00014}00014\ \textcolor{comment}{\ *\ limitations\ under\ the\ License.}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00015}00015\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00016}00016\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00017}00017\ \textcolor{preprocessor}{\#include\ <string.h>}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00018}00018\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{stdint_8h}{stdint.h}}>}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00019}00019\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00020}00020\ \textcolor{preprocessor}{\#include\ <errno.h>}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00021}00021\ \textcolor{preprocessor}{\#include\ <limits.h>}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00023}00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{yubihsm_8h}{yubihsm.h}}"{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00024}00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lib_2internal_8h}{internal.h}}"{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00025}00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{debug__lib_8h}{debug\_lib.h}}"{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00027}\mbox{\hyperlink{lib__util_8c_a6eb7b89af94c6b62b4df98a7471b9265}{00027}}\ \textcolor{preprocessor}{\#define\ STATUS\_STR\ "{}status="{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00028}\mbox{\hyperlink{lib__util_8c_acfc1668731750cb1ee8974b8a7c133ef}{00028}}\ \textcolor{preprocessor}{\#define\ VERSION\_STR\ "{}version="{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00029}\mbox{\hyperlink{lib__util_8c_a554ac61ee838b64249c11f699105c81d}{00029}}\ \textcolor{preprocessor}{\#define\ PID\_STR\ "{}pid="{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00030}\mbox{\hyperlink{lib__util_8c_af7a4720d20739b2f97ebd287f9ab17c3}{00030}}\ \textcolor{preprocessor}{\#define\ ADDRESS\_STR\ "{}address="{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00031}\mbox{\hyperlink{lib__util_8c_a41d23fa74c77453e61601bbcc33d531b}{00031}}\ \textcolor{preprocessor}{\#define\ PORT\_STR\ "{}port="{}}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00033}\mbox{\hyperlink{lib_2internal_8h_ab6791ffb401264facac44a8380c7eed4}{00033}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{lib__util_8c_aee9b575511df24bbb5b165e68179bfa0}{dump\_hex}}(FILE\ *file,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}\ *ptr,\ \mbox{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}}\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a7360b55975153b822efc5217b7734e6a}{len}})\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00035}00035\ \ \ \mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ i;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00037}00037\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a7360b55975153b822efc5217b7734e6a}{len}};\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00038}00038\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ \&\&\ !(i\ \%\ 8))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00039}00039\ \ \ \ \ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}\ "{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00040}00040\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00041}00041\ \ \ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}\%02x"{}},\ ptr[i]);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00042}00042\ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00043}00043\ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00045}\mbox{\hyperlink{lib_2internal_8h_afcc4c2f4445fb1ad48fd52af8df2cf02}{00045}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{lib__util_8c_aaa448a1de5a1f61bc28ce4dcac49c3f3}{dump\_msg}}(FILE\ *file,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{union___msg}{Msg}}\ *msg)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00047}00047\ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}SEND\ >>\ (03\ +\ \%04d)\ \%02x\ \%04x\ "{}},\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.cmd,}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00048}00048\ \ \ \ \ \ \ \ \ \ \ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00050}00050\ \ \ \mbox{\hyperlink{lib__util_8c_aee9b575511df24bbb5b165e68179bfa0}{dump\_hex}}(file,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.data,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00051}00051\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00052}00052\ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00053}00053\ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00055}\mbox{\hyperlink{lib_2internal_8h_a49b565ef91ab66af53803f6e387e85e0}{00055}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{lib__util_8c_a6365a67494ccb75fbe94887befac8510}{dump\_response}}(FILE\ *file,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{union___msg}{Msg}}\ *msg)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00057}00057\ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}RECV\ <<\ (03\ +\ \%04d)\ \%02x\ \%04x\ "{}},\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.cmd,}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00060}00060\ \ \ \mbox{\hyperlink{lib__util_8c_aee9b575511df24bbb5b165e68179bfa0}{dump\_hex}}(file,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.data,\ msg-\/>\mbox{\hyperlink{union___msg_a6b67958147999d1199c922c26763d7f0}{st}}.len);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00062}00062\ \ \ fprintf(file,\ \textcolor{stringliteral}{"{}\ \(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00063}00063\ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00064}00064\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00065}\mbox{\hyperlink{lib_2internal_8h_aa29fabe514d9930d1bbc4cadf5758497}{00065}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{lib__util_8c_aef0d416efb83da9052ee947953ec3b6d}{parse\_status\_data}}(\textcolor{keywordtype}{char}\ *data,\ \mbox{\hyperlink{structyh__connector}{yh\_connector}}\ *connector)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00067}00067\ \ \ \textcolor{keywordtype}{char}\ *saveptr\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00068}00068\ \ \ \textcolor{keywordtype}{char}\ *str\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00069}00069\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00070}00070\ \ \ \textcolor{keywordflow}{while}\ ((str\ =\ strtok\_r(str\ ?\ NULL\ :\ data,\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}},\ \&saveptr)))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00071}00071\ \ \ \ \ \textcolor{keywordflow}{if}\ (strncmp(str,\ \mbox{\hyperlink{lib__util_8c_a6eb7b89af94c6b62b4df98a7471b9265}{STATUS\_STR}},\ strlen(\mbox{\hyperlink{lib__util_8c_a6eb7b89af94c6b62b4df98a7471b9265}{STATUS\_STR}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00072}00072\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (strcmp(str\ +\ strlen(\mbox{\hyperlink{lib__util_8c_a6eb7b89af94c6b62b4df98a7471b9265}{STATUS\_STR}}),\ \textcolor{stringliteral}{"{}OK"{}})\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00073}00073\ \ \ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_a5528332cb62657dbe6fc7e795738872a}{has\_device}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00074}00074\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00075}00075\ \ \ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_a5528332cb62657dbe6fc7e795738872a}{has\_device}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00076}00076\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00077}00077\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (strncmp(str,\ \mbox{\hyperlink{lib__util_8c_acfc1668731750cb1ee8974b8a7c133ef}{VERSION\_STR}},\ strlen(\mbox{\hyperlink{lib__util_8c_acfc1668731750cb1ee8974b8a7c133ef}{VERSION\_STR}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00078}00078\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ v\_maj\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00079}00079\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ v\_min\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00080}00080\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ v\_pat\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00082}00082\ \ \ \ \ \ \ str\ =\ str\ +\ strlen(\mbox{\hyperlink{lib__util_8c_acfc1668731750cb1ee8974b8a7c133ef}{VERSION\_STR}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00083}00083\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sscanf(str,\ \textcolor{stringliteral}{"{}\%lu.\%lu.\%lu"{}},\ \&v\_maj,\ \&v\_min,\ \&v\_pat)\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00084}00084\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{debug__lib_8h_a2e3ed21e5ffba18d940d164aaec64a2a}{DBG\_ERR}}(\textcolor{stringliteral}{"{}Unable\ to\ parse\ version\ string"{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00085}00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00086}00086\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00087}00087\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00088}00088\ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_af9b0901bc659e7e0c22d76e350bc7269}{version\_major}}\ =\ v\_maj;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00089}00089\ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_ab53147f120dfdfa7f19882b8631401ce}{version\_minor}}\ =\ v\_min;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00090}00090\ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_a888c95a32a81c6c6e62f336214e965fa}{version\_patch}}\ =\ v\_pat;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00091}00091\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (strncmp(str,\ \mbox{\hyperlink{lib__util_8c_a554ac61ee838b64249c11f699105c81d}{PID\_STR}},\ strlen(\mbox{\hyperlink{lib__util_8c_a554ac61ee838b64249c11f699105c81d}{PID\_STR}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00092}00092\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *endptr;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00093}00093\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ pid;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00094}00094\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00095}00095\ \ \ \ \ \ \ str\ =\ str\ +\ strlen(\mbox{\hyperlink{lib__util_8c_a554ac61ee838b64249c11f699105c81d}{PID\_STR}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00096}00096\ \ \ \ \ \ \ errno\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00097}00097\ \ \ \ \ \ \ pid\ =\ strtoul(str,\ \&endptr,\ 0);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00098}00098\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((errno\ ==\ ERANGE\ \&\&\ pid\ ==\ ULONG\_MAX)\ ||\ (errno\ !=\ 0\ \&\&\ pid\ ==\ 0))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00099}00099\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00100}00100\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00101}00101\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00102}00102\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (endptr\ ==\ str\ ||\ pid\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00103}00103\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00104}00104\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00105}00105\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00106}00106\ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_aa2d3ae75568ceaeaf9196046fff0a7ab}{pid}}\ =\ pid;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00107}00107\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (strncmp(str,\ \mbox{\hyperlink{lib__util_8c_af7a4720d20739b2f97ebd287f9ab17c3}{ADDRESS\_STR}},\ strlen(\mbox{\hyperlink{lib__util_8c_af7a4720d20739b2f97ebd287f9ab17c3}{ADDRESS\_STR}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00108}00108\ \ \ \ \ \ \ strncpy((\textcolor{keywordtype}{char}\ *)\ connector-\/>\mbox{\hyperlink{structyh__connector_a72b90da1f0e2f5b24ba1d2ce503754ff}{address}},\ str\ +\ strlen(\mbox{\hyperlink{lib__util_8c_af7a4720d20739b2f97ebd287f9ab17c3}{ADDRESS\_STR}}),}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(connector-\/>\mbox{\hyperlink{structyh__connector_a72b90da1f0e2f5b24ba1d2ce503754ff}{address}})\ -\/\ 1);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00110}00110\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (strncmp(str,\ \mbox{\hyperlink{lib__util_8c_a41d23fa74c77453e61601bbcc33d531b}{PORT\_STR}},\ strlen(\mbox{\hyperlink{lib__util_8c_a41d23fa74c77453e61601bbcc33d531b}{PORT\_STR}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00111}00111\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *endptr;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00112}00112\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ port;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00113}00113\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00114}00114\ \ \ \ \ \ \ str\ =\ str\ +\ strlen(\mbox{\hyperlink{lib__util_8c_a41d23fa74c77453e61601bbcc33d531b}{PORT\_STR}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00115}00115\ \ \ \ \ \ \ errno\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00116}00116\ \ \ \ \ \ \ port\ =\ strtoul(str,\ \&endptr,\ 0);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00117}00117\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((errno\ ==\ ERANGE\ \&\&\ port\ ==\ ULONG\_MAX)\ ||\ (errno\ !=\ 0\ \&\&\ port\ ==\ 0))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00118}00118\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00119}00119\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00120}00120\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00121}00121\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (endptr\ ==\ str\ ||\ port\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00122}00122\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00123}00123\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00124}00124\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00125}00125\ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_a754d38913e8c786c397158a41a6bd8eb}{port}}\ =\ port;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00126}00126\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00127}00127\ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00128}00128\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00129}00129\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}response\ from\ connector"{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00130}00130\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}has\ device:\ \%s"{}},\ connector-\/>\mbox{\hyperlink{structyh__connector_a5528332cb62657dbe6fc7e795738872a}{has\_device}}\ ==\ \textcolor{keyword}{true}\ ?\ \textcolor{stringliteral}{"{}yes"{}}\ :\ \textcolor{stringliteral}{"{}no"{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00131}00131\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}version:\ \%d.\%d.\%d"{}},\ connector-\/>\mbox{\hyperlink{structyh__connector_af9b0901bc659e7e0c22d76e350bc7269}{version\_major}},}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ connector-\/>\mbox{\hyperlink{structyh__connector_ab53147f120dfdfa7f19882b8631401ce}{version\_minor}},\ connector-\/>\mbox{\hyperlink{structyh__connector_a888c95a32a81c6c6e62f336214e965fa}{version\_patch}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00133}00133\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}pid:\ \%u"{}},\ connector-\/>\mbox{\hyperlink{structyh__connector_aa2d3ae75568ceaeaf9196046fff0a7ab}{pid}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00134}00134\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}address:\ \%s"{}},\ connector-\/>\mbox{\hyperlink{structyh__connector_a72b90da1f0e2f5b24ba1d2ce503754ff}{address}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00135}00135\ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}port:\ \%u"{}},\ connector-\/>\mbox{\hyperlink{structyh__connector_a754d38913e8c786c397158a41a6bd8eb}{port}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00136}00136\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00137}00137\ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00138}00138\ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00140}\mbox{\hyperlink{lib_2internal_8h_a8d799abe67a90b2664d589b02092fc53}{00140}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{lib__util_8c_a8bc61bd440a2840d3efb16407e919051}{parse\_usb\_url}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\mbox{\hyperlink{programs_2clio_2main_8cpp_aa03c1ef4c41f36b048cf58d5aade7653}{url}},\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}})\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00141}00141\ \ \ \textcolor{keywordflow}{if}\ (strncmp(\mbox{\hyperlink{programs_2clio_2main_8cpp_aa03c1ef4c41f36b048cf58d5aade7653}{url}},\ \mbox{\hyperlink{yubihsm_8h_a4c5f4e9bfa0e29ea9b0d951c9c928c90}{YH\_USB\_URL\_SCHEME}},\ strlen(\mbox{\hyperlink{yubihsm_8h_a4c5f4e9bfa0e29ea9b0d951c9c928c90}{YH\_USB\_URL\_SCHEME}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00142}00142\ \ \ \ \ \mbox{\hyperlink{programs_2clio_2main_8cpp_aa03c1ef4c41f36b048cf58d5aade7653}{url}}\ +=\ strlen(\mbox{\hyperlink{yubihsm_8h_a4c5f4e9bfa0e29ea9b0d951c9c928c90}{YH\_USB\_URL\_SCHEME}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00143}00143\ \ \ \ \ \textcolor{keywordtype}{char}\ *copy\ =\ strdup(\mbox{\hyperlink{programs_2clio_2main_8cpp_aa03c1ef4c41f36b048cf58d5aade7653}{url}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00144}00144\ \ \ \ \ \textcolor{keywordtype}{char}\ *str\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00145}00145\ \ \ \ \ \textcolor{keywordtype}{char}\ *saveptr\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00146}00146\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00147}00147\ \ \ \ \ \textcolor{comment}{//\ if\ we\ don't\ find\ a\ serial\ we\ still\ want\ to\ return\ serial\ 0}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00148}00148\ \ \ \ \ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00149}00149\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00150}00150\ \ \ \ \ \textcolor{keywordflow}{while}\ ((str\ =\ strtok\_r(str\ ?\ NULL\ :\ copy,\ \textcolor{stringliteral}{"{}\&"{}},\ \&saveptr)))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00151}00151\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (strncmp(str,\ \textcolor{stringliteral}{"{}serial="{}},\ strlen(\textcolor{stringliteral}{"{}serial="{}}))\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00152}00152\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *endptr;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00153}00153\ \ \ \ \ \ \ \ \ str\ +=\ strlen(\textcolor{stringliteral}{"{}serial="{}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00154}00154\ }
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00155}00155\ \ \ \ \ \ \ \ \ errno\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00156}00156\ \ \ \ \ \ \ \ \ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}}\ =\ strtoul(str,\ \&endptr,\ 0);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00157}00157\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((errno\ ==\ ERANGE\ \&\&\ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}}\ ==\ ULONG\_MAX)\ ||\ endptr\ ==\ str\ ||}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ (errno\ !=\ 0\ \&\&\ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}}\ ==\ 0))\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00160}00160\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}Failed\ to\ parse\ serial\ argument:\ '\%s'."{}},\ str);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00161}00161\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00162}00162\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00163}00163\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}Unknown\ USB\ option\ '\%s'."{}},\ str);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00164}00164\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00165}00165\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00166}00166\ \ \ \ \ \mbox{\hyperlink{debug__lib_8h_a8c4742440a149ad8bcb5d58ae76c5ed3}{DBG\_INFO}}(\textcolor{stringliteral}{"{}USB\ url\ parsed\ with\ serial\ \%lu."{}},\ *\mbox{\hyperlink{yubihsm__pkcs11_8c_a1149ca4bd0659030412db8e77bebdf88}{serial}});}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00167}00167\ \ \ \ \ free(copy);}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00168}00168\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00169}00169\ \ \ \}}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00170}00170\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{lib__util_8c_source_l00171}00171\ \}}

\end{DoxyCode}

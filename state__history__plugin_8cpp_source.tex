\doxysection{state\+\_\+history\+\_\+plugin.\+cpp}
\hypertarget{state__history__plugin_8cpp_source}{}\label{state__history__plugin_8cpp_source}\index{plugins/state\_history\_plugin/state\_history\_plugin.cpp@{plugins/state\_history\_plugin/state\_history\_plugin.cpp}}
\mbox{\hyperlink{state__history__plugin_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00001}00001\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{chain_2include_2sysio_2chain_2config_8hpp}{sysio/chain/config.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00002}00002\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{compression_8hpp}{sysio/state\_history/compression.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00003}00003\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{create__deltas_8hpp}{sysio/state\_history/create\_deltas.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00004}00004\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{resource__monitor__plugin_8hpp}{sysio/resource\_monitor\_plugin/resource\_monitor\_plugin.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00005}00005\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{log_8hpp}{sysio/state\_history/log.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00006}00006\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{state__history_2include_2sysio_2state__history_2serialization_8hpp}{sysio/state\_history/serialization.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00007}00007\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{trace__converter_8hpp}{sysio/state\_history/trace\_converter.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00008}00008\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{state__history__plugin_8hpp}{sysio/state\_history\_plugin/state\_history\_plugin.hpp}}>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00009}00009\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00010}00010\ \textcolor{preprocessor}{\#include\ <boost/asio/bind\_executor.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00011}00011\ \textcolor{preprocessor}{\#include\ <boost/asio/ip/host\_name.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00012}00012\ \textcolor{preprocessor}{\#include\ <boost/asio/ip/tcp.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00013}00013\ \textcolor{preprocessor}{\#include\ <boost/asio/strand.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00014}00014\ \textcolor{preprocessor}{\#include\ <boost/beast/core.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00015}00015\ \textcolor{preprocessor}{\#include\ <boost/beast/websocket.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00016}00016\ \textcolor{preprocessor}{\#include\ <boost/signals2/connection.hpp>}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00018}00018\ \textcolor{keyword}{using\ }\mbox{\hyperlink{http__client_8cpp_a2671c4a124c39d4d993506b36d8c59b6}{tcp}}\ \ \ \ =\ boost::asio::ip::tcp;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00019}00019\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{210-_evt-_event_listeners_8cpp_aaf05ec28baf9169e247960554e9ffbcb}{ws}}\ =\ boost::beast::websocket;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00021}00021\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ \mbox{\hyperlink{state__history__plugin_8cpp_ae4097a3d4530483dcbecd2ffc0264aaa}{state\_history\_plugin\_abi}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00023}00023\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacesysio}{sysio}}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00024}00024\ \textcolor{keyword}{using\ namespace\ }chain;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00025}00025\ \textcolor{keyword}{using\ namespace\ }state\_history;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00026}00026\ \textcolor{keyword}{using\ }boost::signals2::scoped\_connection;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00028}00028\ \textcolor{keyword}{static}\ \mbox{\hyperlink{classappbase_1_1abstract__plugin}{appbase::abstract\_plugin}}\&\ \_state\_history\_plugin\ =\ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().\mbox{\hyperlink{classappbase_1_1application_a87e84549150056c56c0327cc4976cc2a}{register\_plugin}}<state\_history\_plugin>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00030}00030\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ F>}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00031}\mbox{\hyperlink{namespacesysio_a39cc68aac0c6e19efdcf077c000b87a7}{00031}}\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{namespacesysio_a39cc68aac0c6e19efdcf077c000b87a7}{catch\_and\_log}}(F\ \mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00032}00032\ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00033}00033\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00034}00034\ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classfc_1_1exception}{fc::exception}}\&\ e)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00035}00035\ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{e\}"{}},\ (\textcolor{stringliteral}{"{}e"{}},\ e.\mbox{\hyperlink{classfc_1_1exception_a7611ea8fbe25dde56649b685c2298a37}{to\_detail\_string}}()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00036}00036\ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ std::exception\&\ e)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00037}00037\ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{e\}"{}},\ (\textcolor{stringliteral}{"{}e"{}},\ e.\mbox{\hyperlink{classfc_1_1exception_ab1104818bf0d9b6a29f0dfe036cf97f6}{what}}()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00038}00038\ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00039}00039\ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}unknown\ exception"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00040}00040\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00041}00041\ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00042}00042\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00043}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl}{00043}}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl}{state\_history\_plugin\_impl}}\ :\ std::enable\_shared\_from\_this<state\_history\_plugin\_impl>\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00044}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{00044}}\ \ \ \ \mbox{\hyperlink{classsysio_1_1chain__plugin}{chain\_plugin}}*\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{chain\_plug}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00045}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{00045}}\ \ \ \ std::optional<state\_history\_log>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00046}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{00046}}\ \ \ \ std::optional<state\_history\_log>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00047}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa15bf609ad3717258b4efeedb797b7d6}{00047}}\ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa15bf609ad3717258b4efeedb797b7d6}{trace\_debug\_mode}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00048}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ae6d60f7f7d51ac9bdb5e371dc65fc689}{00048}}\ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ae6d60f7f7d51ac9bdb5e371dc65fc689}{stopping}}\ \ \ \ \ \ \ \ \ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00049}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa276ab215f0a9cb920083343a0bbc02f}{00049}}\ \ \ \ std::optional<scoped\_connection>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa276ab215f0a9cb920083343a0bbc02f}{applied\_transaction\_connection}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00050}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab775b914c7586cd47b366f7bbb7007f9}{00050}}\ \ \ \ std::optional<scoped\_connection>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab775b914c7586cd47b366f7bbb7007f9}{block\_start\_connection}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00051}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a20d4a6d1a901fe6aa14a2e13554a8834}{00051}}\ \ \ \ std::optional<scoped\_connection>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a20d4a6d1a901fe6aa14a2e13554a8834}{accepted\_block\_connection}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00052}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a85a9831f498ad989b757699d91c64e0b}{00052}}\ \ \ \ \textcolor{keywordtype}{string}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a85a9831f498ad989b757699d91c64e0b}{endpoint\_address}}\ =\ \textcolor{stringliteral}{"{}0.0.0.0"{}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00053}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a675dbf4b298fdea99a1622ca781f474a}{00053}}\ \ \ \ \mbox{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a675dbf4b298fdea99a1622ca781f474a}{endpoint\_port}}\ \ \ \ =\ 8080;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00054}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{00054}}\ \ \ \ std::unique\_ptr<tcp::acceptor>\ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00055}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a3ee433db4de5dff30dae5963e7312618}{00055}}\ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter}{state\_history::trace\_converter}}\ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a3ee433db4de5dff30dae5963e7312618}{trace\_converter}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00057}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56d753369a9efd6baba579e7c78bc215}{00057}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56d753369a9efd6baba579e7c78bc215}{get\_log\_entry}}(\mbox{\hyperlink{classsysio_1_1state__history__log}{state\_history\_log}}\&\ log,\ \mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ block\_num,\ std::optional<bytes>\&\ result)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00058}00058\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (block\_num\ <\ log.begin\_block()\ ||\ block\_num\ >=\ log.end\_block())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00059}00059\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00060}00060\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__log__header}{state\_history\_log\_header}}\ header;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00061}00061\ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\ =\ log.get\_entry(block\_num,\ header);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00062}00062\ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00063}00063\ \ \ \ \ \ \ \textcolor{comment}{//\ Compressed\ deltas\ now\ exceeds\ 4GB\ on\ one\ of\ the\ public\ chains.\ This\ length\ prefix}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00064}00064\ \ \ \ \ \ \ \textcolor{comment}{//\ was\ intended\ to\ support\ adding\ additional\ fields\ in\ the\ future\ after\ the}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00065}00065\ \ \ \ \ \ \ \textcolor{comment}{//\ packed\ deltas\ or\ packed\ traces.\ For\ now\ we're\ going\ to\ ignore\ on\ read.}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00066}00066\ \ \ \ \ \ \ stream.read((\textcolor{keywordtype}{char}*)\&\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}},\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00067}00067\ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_aec6fcb673ff035718c238c8c9d544c47}{uint64\_t}}\ s2\ =\ header.\mbox{\hyperlink{structsysio_1_1state__history__log__header_a544a9348436f1bc1aad6304a35d08cde}{payload\_size}}\ -\/\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00068}00068\ \ \ \ \ \ \ \mbox{\hyperlink{classfc_1_1vector}{bytes}}\ \ \ \ compressed(s2);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00069}00069\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (s2)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00070}00070\ \ \ \ \ \ \ \ \ \ stream.read(compressed.data(),\ s2);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00071}00071\ \ \ \ \ \ \ result\ =\ \mbox{\hyperlink{namespacesysio_1_1state__history_a81fbdf52169b3b2295f3911729f09142}{state\_history::zlib\_decompress}}(compressed);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00072}00072\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00073}00073\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00074}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a7ef3e3d06885019c0534ea6ce523a53b}{00074}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a7ef3e3d06885019c0534ea6ce523a53b}{get\_block}}(\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ block\_num,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}},\ std::optional<bytes>\&\ result)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00075}00075\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_1_1chain_aa10ee348c57604b615bc8570f6685102}{chain::signed\_block\_ptr}}\ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00076}00076\ \ \ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00077}00077\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}\ \&\&\ block\_num\ ==\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1detail_1_1block__header__state__common_ae85e3375836639cb1e7543aea7cf0552}{block\_num}}\ )\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00078}00078\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}\ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__state_ad8990c23fb472651541b5e19ec27bc59}{block}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}\ =\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{chain\_plug}}-\/>\mbox{\hyperlink{classsysio_1_1chain__plugin_a14a5e77b31ecf267c8062267d03440ae}{chain}}().\mbox{\hyperlink{classsysio_1_1chain_1_1controller_a1379e43325b7e517a058bddce15571eb}{fetch\_block\_by\_number}}(\ block\_num\ );}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00081}00081\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00082}00082\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00083}00083\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00084}00084\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00085}00085\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00086}00086\ \ \ \ \ \ \ \ \ \ result\ =\ \mbox{\hyperlink{namespacefc_1_1raw_a3a18d8161aa5b4f4f02b6fcfdff5e5d1}{fc::raw::pack}}(*\mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00087}00087\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00088}00088\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00089}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ace95f06f4285cacae5b90fd9d1d37d9b}{00089}}\ \ \ \ std::optional<chain::block\_id\_type>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ace95f06f4285cacae5b90fd9d1d37d9b}{get\_block\_id}}(\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ block\_num)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00090}00090\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}}\ \&\&\ block\_num\ >=\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}}-\/>begin\_block()\ \&\&\ block\_num\ <\ trace\_log-\/>end\_block())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00091}00091\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}}-\/>get\_block\_id(block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00092}00092\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}\ \&\&\ block\_num\ >=\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}-\/>begin\_block()\ \&\&\ block\_num\ <\ chain\_state\_log-\/>end\_block())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}-\/>get\_block\_id(block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00094}00094\ \ \ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00095}00095\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{chain\_plug}}-\/>\mbox{\hyperlink{classsysio_1_1chain__plugin_a14a5e77b31ecf267c8062267d03440ae}{chain}}().\mbox{\hyperlink{classsysio_1_1chain_1_1controller_a9a55edb4766f1f3302ede12e329b1ea6}{get\_block\_id\_for\_num}}(block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00096}00096\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{\}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00097}00097\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00098}00098\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00099}00099\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00100}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session}{00100}}\ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session}{session}}\ :\ std::enable\_shared\_from\_this<session>\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00101}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a0b52bdba191da292fa565f1dff8428fd}{00101}}\ \ \ \ \ \ \ std::shared\_ptr<state\_history\_plugin\_impl>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a0b52bdba191da292fa565f1dff8428fd}{plugin}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00102}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{00102}}\ \ \ \ \ \ \ std::unique\_ptr<ws::stream<tcp::socket>>\ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00103}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a063d7f178fc69d9090a8aa1b0eb61221}{00103}}\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a063d7f178fc69d9090a8aa1b0eb61221}{sending}}\ \ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00104}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a373eff86875491f81d3f8116bc537db0}{00104}}\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a373eff86875491f81d3f8116bc537db0}{sent\_abi}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00105}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{00105}}\ \ \ \ \ \ \ std::vector<std::vector<char>>\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00106}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{00106}}\ \ \ \ \ \ \ std::optional<get\_blocks\_request\_v0>\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00107}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{00107}}\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00108}00108\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00109}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a3cd33110b680ab466ee00253864dd3bf}{00109}}\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a3cd33110b680ab466ee00253864dd3bf}{session}}(std::shared\_ptr<state\_history\_plugin\_impl>\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}(\mbox{\hyperlink{namespacestd}{std}}::move(\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}))\ \{\}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00111}00111\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00112}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a32b08f79712865d9f6f7fd9ede4fa857}{00112}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a32b08f79712865d9f6f7fd9ede4fa857}{start}}(tcp::socket\ socket)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00113}00113\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a831cf08dc63704c11fd154132c6e8bdb}{ilog}}(\textcolor{stringliteral}{"{}incoming\ connection"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}\ =\ std::make\_unique<ws::stream<tcp::socket>>(std::move(socket));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00115}00115\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>binary(\textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00116}00116\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>next\_layer().set\_option(boost::asio::ip::tcp::no\_delay(\textcolor{keyword}{true}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>next\_layer().set\_option(boost::asio::socket\_base::send\_buffer\_size(1024\ *\ 1024));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>next\_layer().set\_option(boost::asio::socket\_base::receive\_buffer\_size(1024\ *\ 1024));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>async\_accept([\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}\ =\ shared\_from\_this()](boost::system::error\_code\ ec)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00120}00120\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>callback(ec,\ \textcolor{stringliteral}{"{}async\_accept"{}},\ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}]\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>start\_read();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>send(\mbox{\hyperlink{abi_8cpp_ae4097a3d4530483dcbecd2ffc0264aaa}{state\_history\_plugin\_abi}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00125}00125\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00126}00126\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00127}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a11af9b8b9ca48cfa4ba8c0bdfc94f3af}{00127}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a11af9b8b9ca48cfa4ba8c0bdfc94f3af}{start\_read}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ in\_buffer\ =\ std::make\_shared<boost::beast::flat\_buffer>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>async\_read(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00130}00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ *in\_buffer,\ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}\ =\ shared\_from\_this(),\ in\_buffer](boost::system::error\_code\ ec,\ \textcolor{keywordtype}{size\_t})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>callback(ec,\ \textcolor{stringliteral}{"{}async\_read"{}},\ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}},\ in\_buffer]\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a107648633008a7f2d872b4b3d98c2f96}{d}}\ =\ boost::asio::buffer\_cast<char\ const*>(boost::beast::buffers\_front(in\_buffer-\/>data()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}\ =\ boost::asio::buffer\_size(in\_buffer-\/>data());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00134}00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classfc_1_1datastream}{fc::datastream<const\ char*>}}\ ds(\mbox{\hyperlink{yubihsm__pkcs11_8c_a107648633008a7f2d872b4b3d98c2f96}{d}},\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_1_1state__history_a0e788deef6248a86a8620bdbf4dea020}{state\_request}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ req;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacefc_1_1raw_a0b442d98ceb22dd5a6ae84745e43ffab}{fc::raw::unpack}}(ds,\ req);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::visit(*\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}},\ req);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>start\_read();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00141}00141\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00142}00142\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00143}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a43d48af2140f59121b87b1cb59a83368}{00143}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a43d48af2140f59121b87b1cb59a83368}{send}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.push\_back(\{\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}},\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}\ +\ strlen(\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}})\});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{send}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00146}00146\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00147}00147\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00148}00148\ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00149}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac14c4a6544d49506a065e86c0f3bf2b3}{00149}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac14c4a6544d49506a065e86c0f3bf2b3}{send}}(\mbox{\hyperlink{prettywritertest_8cpp_a6283df8c4e365cc8a01727e2d7ad44bf}{T}}\ obj)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.push\_back(\mbox{\hyperlink{namespacefc_1_1raw_a3a18d8161aa5b4f4f02b6fcfdff5e5d1}{fc::raw::pack}}(\mbox{\hyperlink{namespacesysio_1_1state__history_a7c0ebdf566e085620947b3981fb324ec}{state\_result}}\{std::move(obj)\}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{send}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00152}00152\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00153}00153\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00154}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{00154}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{send}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a063d7f178fc69d9090a8aa1b0eb61221}{sending}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.empty())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a063d7f178fc69d9090a8aa1b0eb61221}{sending}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00160}00160\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>binary(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a373eff86875491f81d3f8116bc537db0}{sent\_abi}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00161}00161\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a373eff86875491f81d3f8116bc537db0}{sent\_abi}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00162}00162\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>async\_write(\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ boost::asio::buffer(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}[0]),\ \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}\ =\ shared\_from\_this()](boost::system::error\_code\ ec,\ \textcolor{keywordtype}{size\_t})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>callback(ec,\ \textcolor{stringliteral}{"{}async\_write"{}},\ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}]\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>send\_queue.erase(\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>send\_queue.begin());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>sending\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}-\/>send();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00169}00169\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00170}00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00171}00171\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00172}00172\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00173}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_adefb2e4dc7f9df0757692d574647b4c2}{00173}}\ \ \ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_adefb2e4dc7f9df0757692d574647b4c2}{result\_type}}\ =\ void;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00174}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a8a04f269bddae7be304148383eb5f841}{00174}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a8a04f269bddae7be304148383eb5f841}{operator()}}(\mbox{\hyperlink{structsysio_1_1state__history_1_1get__status__request__v0}{get\_status\_request\_v0}}\&)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00175}00175\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ chain\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_plug-\/>chain();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1get__status__result__v0}{get\_status\_result\_v0}}\ result;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00177}00177\ \ \ \ \ \ \ \ \ \ result.head\ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ \{chain.head\_block\_num(),\ chain.head\_block\_id()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00178}00178\ \ \ \ \ \ \ \ \ \ result.last\_irreversible\ =\ \{chain.last\_irreversible\_block\_num(),\ chain.last\_irreversible\_block\_id()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00179}00179\ \ \ \ \ \ \ \ \ \ result.chain\_id\ \ \ \ \ \ \ \ \ \ =\ chain.get\_chain\_id();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00180}00180\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>trace\_log)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00181}00181\ \ \ \ \ \ \ \ \ \ \ \ \ result.trace\_begin\_block\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>trace\_log-\/>begin\_block();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00182}00182\ \ \ \ \ \ \ \ \ \ \ \ \ result.trace\_end\_block\ \ \ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>trace\_log-\/>end\_block();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00184}00184\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_state\_log)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00185}00185\ \ \ \ \ \ \ \ \ \ \ \ \ result.chain\_state\_begin\_block\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_state\_log-\/>begin\_block();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00186}00186\ \ \ \ \ \ \ \ \ \ \ \ \ result.chain\_state\_end\_block\ \ \ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_state\_log-\/>end\_block();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00188}00188\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{send}}(std::move(result));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00189}00189\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00190}00190\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00191}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a3f2b52fad830aec966bcf5a7bc84ae2a}{00191}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a3f2b52fad830aec966bcf5a7bc84ae2a}{operator()}}(\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0}{get\_blocks\_request\_v0}}\&\ req)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00192}00192\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\&\ cp\ :\ req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0_a491cc2f7ac7e4b5066c6674b93dcc2df}{have\_positions}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00193}00193\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0_a44ce68bf25ea4ca4cd0f29e107961d50}{start\_block\_num}}\ <=\ cp.block\_num)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00194}00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00195}00195\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keywordtype}{id}\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_block\_id(cp.block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\textcolor{keywordtype}{id}\ ||\ *\textcolor{keywordtype}{id}\ !=\ cp.block\_id)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0_a44ce68bf25ea4ca4cd0f29e107961d50}{start\_block\_num}}\ =\ std::min(req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0_a44ce68bf25ea4ca4cd0f29e107961d50}{start\_block\_num}},\ cp.block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00199}00199\ \ \ \ \ \ \ \ \ \ req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__request__v0_a491cc2f7ac7e4b5066c6674b93dcc2df}{have\_positions}}.clear();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}\ =\ req;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}(\textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00202}00202\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00203}00203\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00204}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a57b7afe6688f1c54848a58349a45047c}{00204}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a57b7afe6688f1c54848a58349a45047c}{operator()}}(\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__ack__request__v0}{get\_blocks\_ack\_request\_v0}}\&\ req)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>max\_messages\_in\_flight\ +=\ req.\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__ack__request__v0_a3b29777881a72e62f26e70a596a7dfbd}{num\_messages}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00208}00208\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00209}00209\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00210}00210\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00211}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{00211}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}(\mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__result__v0}{get\_blocks\_result\_v0}}\ result,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00212}00212\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00213}00213\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.empty()\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>max\_messages\_in\_flight)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ chain\ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_plug-\/>chain();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00216}00216\ \ \ \ \ \ \ \ \ \ result.last\_irreversible\ =\ \{chain.last\_irreversible\_block\_num(),\ chain.last\_irreversible\_block\_id()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ current\ =}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00218}00218\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>irreversible\_only\ ?\ result.last\_irreversible.block\_num\ :\ result.head.block\_num;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00219}00219\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ <=\ current\ \&\&}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00220}00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ <\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>end\_block\_num)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00221}00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_id\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_block\_id(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (block\_id)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00223}00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ result.this\_block\ \ =\ \mbox{\hyperlink{structsysio_1_1state__history_1_1block__position}{block\_position}}\{\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num,\ *block\_id\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00224}00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ prev\_block\_id\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_block\_id(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ -\/\ 1);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00225}00225\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_block\_id)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00226}00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ result.prev\_block\ =\ \mbox{\hyperlink{structsysio_1_1state__history_1_1block__position}{block\_position}}\{\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ -\/\ 1,\ *prev\_block\_id\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00227}00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>fetch\_block)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_block(\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num,\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}},\ result.block\ );}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00230}00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>fetch\_traces\ \&\&\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>trace\_log)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00231}00231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_log\_entry(*\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>trace\_log,\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num,\ result.traces);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00232}00232\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>fetch\_deltas\ \&\&\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_state\_log)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00233}00233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>get\_log\_entry(*\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_state\_log,\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num,\ result.deltas);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00234}00234\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ ++\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00237}00237\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a75102a1a12cdf641267a4ad44813503a}{send}}(std::move(result));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00238}00238\ \ \ \ \ \ \ \ \ \ -\/-\/\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>max\_messages\_in\_flight;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00239}00239\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ =\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ <=\ current\ \&\&}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00240}00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>start\_block\_num\ <\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>end\_block\_num;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00241}00241\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00242}00242\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00243}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5e595a743feb07936a8ddba0131bc856}{00243}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5e595a743feb07936a8ddba0131bc856}{send\_update}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00244}00244\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00245}00245\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.empty()\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>max\_messages\_in\_flight)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00247}00247\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__result__v0}{get\_blocks\_result\_v0}}\ result;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00248}00248\ \ \ \ \ \ \ \ \ \ result.head\ =\ \{\mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1detail_1_1block__header__state__common_ae85e3375836639cb1e7543aea7cf0552}{block\_num}},\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__header__state_a19f6899e80705092e990411eaed6e7a8}{id}}\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00249}00249\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}(std::move(result),\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00250}00250\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00251}00251\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00252}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_aa4fee32d71ab41e65315338411c3748c}{00252}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_aa4fee32d71ab41e65315338411c3748c}{send\_update}}(\textcolor{keywordtype}{bool}\ changed\ =\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00253}00253\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (changed)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00254}00254\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00255}00255\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ad43d0e5fd9c0fb69e92fe7cf173082e8}{send\_queue}}.empty()\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a5b58c569f9182397a38f5d2c8c84ebcf}{need\_to\_send\_update}}\ ||\ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}\ ||}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00256}00256\ \ \ \ \ \ \ \ \ \ \ \ \ \ !\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac69354c3678235cceb5e957452bd2925}{current\_request}}-\/>max\_messages\_in\_flight)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00257}00257\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00258}00258\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ chain\ =\ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>chain\_plug-\/>chain();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00259}00259\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1get__blocks__result__v0}{get\_blocks\_result\_v0}}\ result;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00260}00260\ \ \ \ \ \ \ \ \ \ result.head\ =\ \{chain.head\_block\_num(),\ chain.head\_block\_id()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00261}00261\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a7cd34f5d9ec817197d11d7e2e6b51292}{send\_update}}(std::move(result),\ \{\});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00262}00262\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00263}00263\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00264}00264\ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ F>}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00265}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_abc70d4152ee00348029c61a9bcc85a6f}{00265}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_abc70d4152ee00348029c61a9bcc85a6f}{catch\_and\_close}}(F\ \mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00266}00266\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00267}00267\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00268}00268\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classfc_1_1exception}{fc::exception}}\&\ e)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00269}00269\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{e\}"{}},\ (\textcolor{stringliteral}{"{}e"{}},\ e.\mbox{\hyperlink{classfc_1_1exception_a7611ea8fbe25dde56649b685c2298a37}{to\_detail\_string}}()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00270}00270\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{close}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00271}00271\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ std::exception\&\ e)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00272}00272\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{e\}"{}},\ (\textcolor{stringliteral}{"{}e"{}},\ e.\mbox{\hyperlink{classfc_1_1exception_ab1104818bf0d9b6a29f0dfe036cf97f6}{what}}()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00273}00273\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{close}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00274}00274\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00275}00275\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}unknown\ exception"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00276}00276\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{close}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00277}00277\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00278}00278\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00279}00279\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00280}00280\ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ F>}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00281}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_aa305d7b95c5825b8b786aebd283d7eb4}{00281}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_aa305d7b95c5825b8b786aebd283d7eb4}{callback}}(boost::system::error\_code\ ec,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ what,\ F\ \mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().\mbox{\hyperlink{classappbase_1_1application_a77aff91b861010fd61a616c59b310dcc}{post}}(\mbox{\hyperlink{structappbase_1_1priority_a89fc0f21b0f87574f0299932fc1724b4}{priority::medium}},\ [=]()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00283}00283\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>stopping)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00284}00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00285}00285\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ec)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00286}00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a39c66f17854fd671de6749d4c3346207}{on\_fail}}(ec,\ what);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00287}00287\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_abc70d4152ee00348029c61a9bcc85a6f}{catch\_and\_close}}(\mbox{\hyperlink{_x02-_disabled_macros_8cpp_ae28240b98d91d6eb7da702b770490f39}{f}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00288}00288\ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00289}00289\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00290}00290\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00291}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a39c66f17854fd671de6749d4c3346207}{00291}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a39c66f17854fd671de6749d4c3346207}{on\_fail}}(boost::system::error\_code\ ec,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ what)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00292}00292\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00293}00293\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ec\ ==\ boost::asio::error::eof)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00294}00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a3da1571bad6ca6c94df9a3660b2115ee}{dlog}}(\textcolor{stringliteral}{"{}\$\{w\}:\ \$\{m\}"{}},\ (\textcolor{stringliteral}{"{}w"{}},\ what)(\textcolor{stringliteral}{"{}m"{}},\ ec.message()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00295}00295\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00296}00296\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{w\}:\ \$\{m\}"{}},\ (\textcolor{stringliteral}{"{}w"{}},\ what)(\textcolor{stringliteral}{"{}m"{}},\ ec.message()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00297}00297\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00298}00298\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{close}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00299}00299\ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00300}00300\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}uncaught\ exception\ on\ close"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00301}00301\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00302}00302\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00303}00303\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00304}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{00304}}\ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_a6261f9fdfff9e0784b09ee4039523a9e}{close}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00305}00305\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_1_1session_ac8c2ace1089e3f85745575b5202d41d1}{socket\_stream}}-\/>next\_layer().close();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00306}00306\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classappbase_1_1plugin}{plugin}}-\/>sessions.erase(\textcolor{keyword}{this});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00307}00307\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00308}00308\ \ \ \ \};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00309}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b718f0ae6e2f9daa4d578a70ca1d6cf}{00309}}\ \ \ \ std::map<session*,\ std::shared\_ptr<session>>\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b718f0ae6e2f9daa4d578a70ca1d6cf}{sessions}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00310}00310\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00311}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa07f08c970ed998ace29eefae07b34a8}{00311}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa07f08c970ed998ace29eefae07b34a8}{listen}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00312}00312\ \ \ \ \ \ \ boost::system::error\_code\ ec;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00313}00313\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00314}00314\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ address\ \ =\ boost::asio::ip::make\_address(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a85a9831f498ad989b757699d91c64e0b}{endpoint\_address}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00315}00315\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ endpoint\ =\ tcp::endpoint\{address,\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a675dbf4b298fdea99a1622ca781f474a}{endpoint\_port}}\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00316}00316\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}\ \ \ \ \ \ =\ std::make\_unique<tcp::acceptor>(\mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().get\_io\_service());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00317}00317\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00318}00318\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{integration_8cpp_a52bf86a8ad8e1f4b06a5071f23327e5a}{check\_ec}}\ =\ [\&](\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ what)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00319}00319\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!ec)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00320}00320\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00321}00321\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}\$\{w\}:\ \$\{m\}"{}},\ (\textcolor{stringliteral}{"{}w"{}},\ what)(\textcolor{stringliteral}{"{}m"{}},\ ec.message()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00322}00322\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a40c2826a6fba35c1ffbf912bdf559792}{SYS\_ASSERT}}(\textcolor{keyword}{false},\ plugin\_exception,\ \textcolor{stringliteral}{"{}unable\ to\ open\ listen\ socket"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00323}00323\ \ \ \ \ \ \ \};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00324}00324\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00325}00325\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}-\/>open(endpoint.protocol(),\ ec);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00326}00326\ \ \ \ \ \ \ \mbox{\hyperlink{integration_8cpp_a52bf86a8ad8e1f4b06a5071f23327e5a}{check\_ec}}(\textcolor{stringliteral}{"{}open"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00327}00327\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}-\/>set\_option(boost::asio::socket\_base::reuse\_address(\textcolor{keyword}{true}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00328}00328\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}-\/>bind(endpoint,\ ec);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00329}00329\ \ \ \ \ \ \ \mbox{\hyperlink{integration_8cpp_a52bf86a8ad8e1f4b06a5071f23327e5a}{check\_ec}}(\textcolor{stringliteral}{"{}bind"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00330}00330\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}-\/>listen(boost::asio::socket\_base::max\_listen\_connections,\ ec);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00331}00331\ \ \ \ \ \ \ \mbox{\hyperlink{integration_8cpp_a52bf86a8ad8e1f4b06a5071f23327e5a}{check\_ec}}(\textcolor{stringliteral}{"{}listen"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00332}00332\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56b6db862623604c7dda3a358ab3d6f6}{do\_accept}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00333}00333\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00334}00334\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00335}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56b6db862623604c7dda3a358ab3d6f6}{00335}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56b6db862623604c7dda3a358ab3d6f6}{do\_accept}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00336}00336\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ socket\ =\ std::make\_shared<tcp::socket>(\mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().get\_io\_service());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00337}00337\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a083a559f89920f6549db0cfa2ff19ea4}{acceptor}}-\/>async\_accept(*socket,\ [\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}}\ =\ shared\_from\_this(),\ socket,\ \textcolor{keyword}{this}](\textcolor{keyword}{const}\ boost::system::error\_code\&\ ec)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00338}00338\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ae6d60f7f7d51ac9bdb5e371dc65fc689}{stopping}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00339}00339\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00340}00340\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ec)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00341}00341\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ec\ ==\ boost::system::errc::too\_many\_files\_open)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00342}00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a39cc68aac0c6e19efdcf077c000b87a7}{catch\_and\_log}}([\&]\ \{\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56b6db862623604c7dda3a358ab3d6f6}{do\_accept}}();\ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00343}00343\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00344}00344\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00345}00345\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a39cc68aac0c6e19efdcf077c000b87a7}{catch\_and\_log}}([\&]\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00346}00346\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}\ \ \ \ \ \ \ \ \ \ \ \ =\ std::make\_shared<session>(\mbox{\hyperlink{namespacesysio_a5c18cd9d34b8c5d3af8e2de75577673fa1f42b089b0bc1105b38f19140a65cc2a}{self}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00347}00347\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b718f0ae6e2f9daa4d578a70ca1d6cf}{sessions}}[\mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}.get()]\ =\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00348}00348\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}-\/>start(std::move(*socket));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00349}00349\ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00350}00350\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesysio_a39cc68aac0c6e19efdcf077c000b87a7}{catch\_and\_log}}([\&]\ \{\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a56b6db862623604c7dda3a358ab3d6f6}{do\_accept}}();\ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00351}00351\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00352}00352\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00353}00353\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00354}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a7b2032a96cd68192060f52a0e3706509}{00354}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a7b2032a96cd68192060f52a0e3706509}{on\_applied\_transaction}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_a4ee2867a6bec961c7a78b203cfd76be9}{transaction\_trace\_ptr}}\&\ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}},\ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_a7041c0316bd294d0866609ab3e0cc7a7}{packed\_transaction\_ptr}}\&\ t)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00355}00355\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00356}00356\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter}{trace\_converter}}.\mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter_ab4ca84fdc2d30675408e6e9f4d4c18c8}{add\_transaction}}(\mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}},\ t);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00357}00357\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00358}00358\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00359}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aaa0729b45ec2388fbc2b5feefde76292}{00359}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aaa0729b45ec2388fbc2b5feefde76292}{on\_accepted\_block}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00360}00360\ \ \ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00361}00361\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a2074796cb93f0dda90a98f2d5ef143ee}{store\_traces}}(\mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00362}00362\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_abada9ce88fb6a33aa4ac4c9d4726bf67}{store\_chain\_state}}(\mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00363}00363\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classfc_1_1exception}{fc::exception}}\&\ e)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00364}00364\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a9e3cdbaecd5a34b42956e888f7326fad}{elog}}(\textcolor{stringliteral}{"{}fc::exception:\ \$\{details\}"{}},\ (\textcolor{stringliteral}{"{}details"{}},\ e.\mbox{\hyperlink{classfc_1_1exception_a7611ea8fbe25dde56649b685c2298a37}{to\_detail\_string}}()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00365}00365\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Both\ app().quit()\ and\ exception\ throwing\ are\ required.\ Without\ app().quit(),}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00366}00366\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ exception\ would\ be\ caught\ and\ drop\ before\ reaching\ main().\ The\ exception\ is}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00367}00367\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ ensure\ the\ block\ won't\ be\ commited.}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00368}00368\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{appbase::app}}().\mbox{\hyperlink{classappbase_1_1application_a81aa58d3f94570b7976145039155fc46}{quit}}();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00369}00369\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a1bfa656552ea0534b2c91ee0fe33f850}{SYS\_THROW}}(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00370}00370\ \ \ \ \ \ \ \ \ \ \ \ \ \ chain::state\_history\_write\_exception,}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00371}00371\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}State\ history\ encountered\ an\ Error\ which\ it\ cannot\ recover\ from.\ \ Please\ resolve\ the\ error\ and\ relaunch\ "{}}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00372}00372\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}the\ process"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00373}00373\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00374}00374\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00375}00375\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\&\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}\ :\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b718f0ae6e2f9daa4d578a70ca1d6cf}{sessions}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00376}00376\ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}\ =\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a506da415c9307c897ca9be93acfe1d0f}{s}}.second;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00377}00377\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00378}00378\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}-\/>current\_request\ \&\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1detail_1_1block__header__state__common_ae85e3375836639cb1e7543aea7cf0552}{block\_num}}\ <\ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}-\/>current\_request-\/>start\_block\_num)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00379}00379\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}-\/>current\_request-\/>start\_block\_num\ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1detail_1_1block__header__state__common_ae85e3375836639cb1e7543aea7cf0552}{block\_num}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00380}00380\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}}-\/>send\_update(\mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00381}00381\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00382}00382\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00383}00383\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00384}00384\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00385}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a5fe584dc482c6efb24bfee245a422aad}{00385}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a5fe584dc482c6efb24bfee245a422aad}{on\_block\_start}}(\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ block\_num)\ \{\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a6283b64f4a4f7575b66117434c188893}{clear\_caches}}();\ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00386}00386\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00387}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a6283b64f4a4f7575b66117434c188893}{00387}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a6283b64f4a4f7575b66117434c188893}{clear\_caches}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00388}00388\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter}{trace\_converter}}.\mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter_ad0809adfb2d44c4587a46763d02efdaf}{cached\_traces}}.clear();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00389}00389\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter}{trace\_converter}}.\mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter_a86c4c2c779102104f43943f1278f58dc}{onblock\_trace}}.reset();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00390}00390\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00391}00391\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00392}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a2074796cb93f0dda90a98f2d5ef143ee}{00392}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a2074796cb93f0dda90a98f2d5ef143ee}{store\_traces}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00393}00393\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00394}00394\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00395}00395\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ traces\_bin\ =\ \mbox{\hyperlink{namespacesysio_1_1state__history_a56d6b703f34519b5d085529ebd120d29}{state\_history::zlib\_compress\_bytes}}(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00396}00396\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter}{trace\_converter}}.\mbox{\hyperlink{structsysio_1_1state__history_1_1trace__converter_a62e0192e6d6919f2171f46b7335eafa5}{pack}}(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{chain\_plug}}-\/>\mbox{\hyperlink{classsysio_1_1chain__plugin_a14a5e77b31ecf267c8062267d03440ae}{chain}}().\mbox{\hyperlink{classsysio_1_1chain_1_1controller_a0c79d00dae8c0d90efc18f4d091b2391}{db}}(),\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_aa15bf609ad3717258b4efeedb797b7d6}{trace\_debug\_mode}},\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00397}00397\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00398}00398\ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a40c2826a6fba35c1ffbf912bdf559792}{SYS\_ASSERT}}(traces\_bin.size()\ ==\ (\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}})traces\_bin.size(),\ plugin\_exception,\ \textcolor{stringliteral}{"{}traces\ is\ too\ big"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00399}00399\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00400}00400\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__log__header}{state\_history\_log\_header}}\ header\{.magic\ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{namespacesysio_adcbaf3936df79b161164e2cd54530f9c}{ship\_magic}}(ship\_current\_version,\ 0),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00401}00401\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .block\_id\ \ \ \ \ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__header__state_a19f6899e80705092e990411eaed6e7a8}{id}},}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00402}00402\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .payload\_size\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}})\ +\ traces\_bin.size()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00403}00403\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a0b55dd4e7ba346185889034127a928a7}{trace\_log}}-\/>write\_entry(header,\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__state_ad8990c23fb472651541b5e19ec27bc59}{block}}-\/>previous,\ [\&](\textcolor{keyword}{auto}\&\ stream)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00404}00404\ \ \ \ \ \ \ \ \ \ uint32\_t\ s\ =\ (uint32\_t)traces\_bin.size();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00405}00405\ \ \ \ \ \ \ \ \ \ stream.write((char*)\&s,\ sizeof(s));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00406}00406\ \ \ \ \ \ \ \ \ \ if\ (!traces\_bin.empty())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00407}00407\ \ \ \ \ \ \ \ \ \ \ \ \ stream.write(traces\_bin.data(),\ traces\_bin.size());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00408}00408\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00409}00409\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00410}00410\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00411}\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_abada9ce88fb6a33aa4ac4c9d4726bf67}{00411}}\ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_abada9ce88fb6a33aa4ac4c9d4726bf67}{store\_chain\_state}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}})\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00412}00412\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}})}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00413}00413\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00414}00414\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ fresh\ =\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}-\/>begin\_block()\ ==\ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}-\/>end\_block();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00415}00415\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fresh)}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00416}00416\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a831cf08dc63704c11fd154132c6e8bdb}{ilog}}(\textcolor{stringliteral}{"{}Placing\ initial\ state\ in\ block\ \$\{n\}"{}},\ (\textcolor{stringliteral}{"{}n"{}},\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__state_ad8990c23fb472651541b5e19ec27bc59}{block}}-\/>block\_num()));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00417}00417\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00418}00418\ \ \ \ \ \ \ std::vector<table\_delta>\ deltas\ \ \ \ \ =\ \mbox{\hyperlink{namespacesysio_1_1state__history_a4672b7cf25419ada24cf1366ef85687d}{state\_history::create\_deltas}}(\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_a654fe8a01daf92d5ae666b0188517279}{chain\_plug}}-\/>\mbox{\hyperlink{classsysio_1_1chain__plugin_a14a5e77b31ecf267c8062267d03440ae}{chain}}().\mbox{\hyperlink{classsysio_1_1chain_1_1controller_a0c79d00dae8c0d90efc18f4d091b2391}{db}}(),\ fresh);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00419}00419\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ deltas\_bin\ =\ \mbox{\hyperlink{namespacesysio_1_1state__history_a56d6b703f34519b5d085529ebd120d29}{state\_history::zlib\_compress\_bytes}}(\mbox{\hyperlink{namespacefc_1_1raw_a3a18d8161aa5b4f4f02b6fcfdff5e5d1}{fc::raw::pack}}(deltas));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00420}00420\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__log__header}{state\_history\_log\_header}}\ header\{.magic\ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{namespacesysio_adcbaf3936df79b161164e2cd54530f9c}{ship\_magic}}(ship\_current\_version,\ 0),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00421}00421\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .block\_id\ \ \ \ \ =\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__header__state_a19f6899e80705092e990411eaed6e7a8}{id}},}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00422}00422\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .payload\_size\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}})\ +\ deltas\_bin.size()\};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00423}00423\ \ \ \ \ \ \ \mbox{\hyperlink{structsysio_1_1state__history__plugin__impl_ab0e254998fcee36e133e5877460fad60}{chain\_state\_log}}-\/>write\_entry(header,\ \mbox{\hyperlink{structsysio_1_1chain_1_1block__state}{block\_state}}-\/>\mbox{\hyperlink{structsysio_1_1chain_1_1block__state_ad8990c23fb472651541b5e19ec27bc59}{block}}-\/>previous,\ [\&](\textcolor{keyword}{auto}\&\ stream)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00424}00424\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Compressed\ deltas\ now\ exceeds\ 4GB\ on\ one\ of\ the\ public\ chains.\ This\ length\ prefix}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00425}00425\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ was\ intended\ to\ support\ adding\ additional\ fields\ in\ the\ future\ after\ the}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00426}00426\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ packed\ deltas.\ For\ now\ we're\ going\ to\ ignore\ on\ read.\ The\ 0\ is\ an\ attempt\ to\ signal}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00427}00427\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ old\ versions\ that\ something's\ not\ quite\ right.}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00428}00428\ \ \ \ \ \ \ \ \ \ uint32\_t\ s\ =\ (uint32\_t)deltas\_bin.size();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00429}00429\ \ \ \ \ \ \ \ \ \ if\ (s\ !=\ deltas\_bin.size())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00430}00430\ \ \ \ \ \ \ \ \ \ \ \ \ s\ =\ 0;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00431}00431\ \ \ \ \ \ \ \ \ \ stream.write((char*)\&s,\ sizeof(s));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00432}00432\ \ \ \ \ \ \ \ \ \ if\ (!deltas\_bin.empty())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00433}00433\ \ \ \ \ \ \ \ \ \ \ \ \ stream.write(deltas\_bin.data(),\ deltas\_bin.size());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00434}00434\ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00435}00435\ \ \ \ \}\ \textcolor{comment}{//\ store\_chain\_state}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00436}00436\ \};\ \ \ \textcolor{comment}{//\ state\_history\_plugin\_impl}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00437}00437\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00438}\mbox{\hyperlink{classsysio_1_1state__history__plugin_a014eff48cf9f6aa978c6926bad90f202}{00438}}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_a014eff48cf9f6aa978c6926bad90f202}{state\_history\_plugin::state\_history\_plugin}}()}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00439}00439\ \ \ \ \ :\ my(\mbox{\hyperlink{namespacestd}{std}}::make\_shared<\mbox{\hyperlink{structsysio_1_1state__history__plugin__impl}{state\_history\_plugin\_impl}}>())\ \{\}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00440}00440\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00441}\mbox{\hyperlink{classsysio_1_1state__history__plugin_ab402c5996a8de4e054c8e7959482a930}{00441}}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_ab402c5996a8de4e054c8e7959482a930}{state\_history\_plugin::\string~state\_history\_plugin}}()\ \{\}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00442}00442\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00443}\mbox{\hyperlink{classsysio_1_1state__history__plugin_a475b7467d5410fc8c53e6ad38503fbda}{00443}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_a475b7467d5410fc8c53e6ad38503fbda}{state\_history\_plugin::set\_program\_options}}(options\_description\&\ \mbox{\hyperlink{xbyak__mnemonic_8h_a4229a9b84f8b8673326f12bd41acd27c}{cli}},\ options\_description\&\ cfg)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00444}00444\ \ \ \ \textcolor{keyword}{auto}\ options\ =\ cfg.add\_options();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00445}00445\ \ \ \ options(\textcolor{stringliteral}{"{}state-\/history-\/dir"{}},\ bpo::value<bfs::path>()-\/>default\_value(\textcolor{stringliteral}{"{}state-\/history"{}}),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00446}00446\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}the\ location\ of\ the\ state-\/history\ directory\ (absolute\ path\ or\ relative\ to\ application\ data\ dir)"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00447}00447\ \ \ \ \mbox{\hyperlink{xbyak__mnemonic_8h_a4229a9b84f8b8673326f12bd41acd27c}{cli}}.add\_options()(\textcolor{stringliteral}{"{}delete-\/state-\/history"{}},\ bpo::bool\_switch()-\/>default\_value(\textcolor{keyword}{false}),\ \textcolor{stringliteral}{"{}clear\ state\ history\ files"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00448}00448\ \ \ \ options(\textcolor{stringliteral}{"{}trace-\/history"{}},\ bpo::bool\_switch()-\/>default\_value(\textcolor{keyword}{false}),\ \textcolor{stringliteral}{"{}enable\ trace\ history"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00449}00449\ \ \ \ options(\textcolor{stringliteral}{"{}chain-\/state-\/history"{}},\ bpo::bool\_switch()-\/>default\_value(\textcolor{keyword}{false}),\ \textcolor{stringliteral}{"{}enable\ chain\ state\ history"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00450}00450\ \ \ \ options(\textcolor{stringliteral}{"{}state-\/history-\/endpoint"{}},\ bpo::value<string>()-\/>default\_value(\textcolor{stringliteral}{"{}127.0.0.1:8080"{}}),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00451}00451\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}the\ endpoint\ upon\ which\ to\ listen\ for\ incoming\ connections.\ Caution:\ only\ expose\ this\ port\ to\ "{}}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00452}00452\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}your\ internal\ network."{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00453}00453\ \ \ \ options(\textcolor{stringliteral}{"{}trace-\/history-\/debug-\/mode"{}},\ bpo::bool\_switch()-\/>default\_value(\textcolor{keyword}{false}),\ \textcolor{stringliteral}{"{}enable\ debug\ mode\ for\ trace\ history"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00454}00454\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00455}00455\ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{classfc_1_1cfile_a36ffef39be181b5580952817617ccf24}{cfile::supports\_hole\_punching}}())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00456}00456\ \ \ \ \ \ \ options(\textcolor{stringliteral}{"{}state-\/history-\/log-\/retain-\/blocks"{}},\ bpo::value<uint32\_t>(),\ \textcolor{stringliteral}{"{}if\ set,\ periodically\ prune\ the\ state\ history\ files\ to\ store\ only\ configured\ number\ of\ most\ recent\ blocks"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00457}00457\ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00458}00458\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00459}\mbox{\hyperlink{classsysio_1_1state__history__plugin_a77b01db68c4deb416c61cebfce6c987a}{00459}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_a77b01db68c4deb416c61cebfce6c987a}{state\_history\_plugin::plugin\_initialize}}(\textcolor{keyword}{const}\ variables\_map\&\ options)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00460}00460\ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00461}00461\ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a40c2826a6fba35c1ffbf912bdf559792}{SYS\_ASSERT}}(options.at(\textcolor{stringliteral}{"{}disable-\/replay-\/opts"{}}).as<\textcolor{keywordtype}{bool}>(),\ plugin\_exception,}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00462}00462\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}state\_history\_plugin\ requires\ -\/-\/disable-\/replay-\/opts"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00463}00463\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00464}00464\ \ \ \ \ \ \ my-\/>chain\_plug\ =\ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().\mbox{\hyperlink{classappbase_1_1application_a1d2c585f90007be342c9c64ee9cc0f7c}{find\_plugin}}<\mbox{\hyperlink{classsysio_1_1chain__plugin}{chain\_plugin}}>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00465}00465\ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a40c2826a6fba35c1ffbf912bdf559792}{SYS\_ASSERT}}(my-\/>chain\_plug,\ chain::missing\_chain\_plugin\_exception,\ \textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00466}00466\ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ chain\ =\ my-\/>chain\_plug-\/>chain();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00467}00467\ \ \ \ \ \ \ my-\/>applied\_transaction\_connection.emplace(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00468}00468\ \ \ \ \ \ \ \ \ \ \ chain.applied\_transaction.connect([\&](std::tuple<const\ transaction\_trace\_ptr\&,\ const\ packed\_transaction\_ptr\&>\ t)\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00469}00469\ \ \ \ \ \ \ \ \ \ \ \ \ \ my-\/>on\_applied\_transaction(std::get<0>(t),\ std::get<1>(t));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00470}00470\ \ \ \ \ \ \ \ \ \ \ \}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00471}00471\ \ \ \ \ \ \ my-\/>accepted\_block\_connection.emplace(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00472}00472\ \ \ \ \ \ \ \ \ \ \ chain.accepted\_block.connect([\&](\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesysio_1_1chain_ab9b14f4554cc4a0da2c361e9757b1662}{block\_state\_ptr}}\&\ \mbox{\hyperlink{bn_8cpp_a8b0eadcc506862e9d751ab45185053aa}{p}})\ \{\ my-\/>on\_accepted\_block(p);\ \}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00473}00473\ \ \ \ \ \ \ my-\/>block\_start\_connection.emplace(}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00474}00474\ \ \ \ \ \ \ \ \ \ \ chain.block\_start.connect([\&](\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}\ block\_num)\ \{\ my-\/>on\_block\_start(block\_num);\ \}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00475}00475\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00476}00476\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dir\_option\ =\ options.at(\textcolor{stringliteral}{"{}state-\/history-\/dir"{}}).as<bfs::path>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00477}00477\ \ \ \ \ \ \ boost::filesystem::path\ state\_history\_dir;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00478}00478\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dir\_option.is\_relative())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00479}00479\ \ \ \ \ \ \ \ \ \ state\_history\_dir\ =\ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().\mbox{\hyperlink{classappbase_1_1application_a5dfd3cfb1124c57963fa17b3f4aabbe1}{data\_dir}}()\ /\ dir\_option;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00480}00480\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00481}00481\ \ \ \ \ \ \ \ \ \ state\_history\_dir\ =\ dir\_option;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00482}00482\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{auto}\ resmon\_plugin\ =\ \mbox{\hyperlink{namespaceappbase_a99374dc23934f008a09f2f79be9eae40}{app}}().find\_plugin<resource\_monitor\_plugin>())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00483}00483\ \ \ \ \ \ \ \ \ \ resmon\_plugin-\/>monitor\_directory(state\_history\_dir);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00484}00484\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00485}00485\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ ip\_port\ \ \ \ \ \ \ \ \ =\ options.at(\textcolor{stringliteral}{"{}state-\/history-\/endpoint"{}}).as<\textcolor{keywordtype}{string}>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00486}00486\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ port\ \ \ \ \ \ \ \ \ \ \ \ =\ ip\_port.substr(ip\_port.find(\textcolor{charliteral}{':'})\ +\ 1,\ ip\_port.size());}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00487}00487\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ host\ \ \ \ \ \ \ \ \ \ \ \ =\ ip\_port.substr(0,\ ip\_port.find(\textcolor{charliteral}{':'}));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00488}00488\ \ \ \ \ \ \ my-\/>endpoint\_address\ =\ \mbox{\hyperlink{programs_2sysio-launcher_2main_8cpp_a8d747b8417c90b78c386111de7934753}{host}};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00489}00489\ \ \ \ \ \ \ my-\/>endpoint\_port\ \ \ \ =\ std::stoi(port);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00490}00490\ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_ac7f967269d8cfcc4cab16d2ec7a04b91}{idump}}((ip\_port)(host)(port));}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00491}00491\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00492}00492\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (options.at(\textcolor{stringliteral}{"{}delete-\/state-\/history"{}}).as<\textcolor{keywordtype}{bool}>())\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00493}00493\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8hpp_a831cf08dc63704c11fd154132c6e8bdb}{ilog}}(\textcolor{stringliteral}{"{}Deleting\ state\ history"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00494}00494\ \ \ \ \ \ \ \ \ \ boost::filesystem::remove\_all(state\_history\_dir);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00495}00495\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00496}00496\ \ \ \ \ \ \ boost::filesystem::create\_directories(state\_history\_dir);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00497}00497\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00498}00498\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (options.at(\textcolor{stringliteral}{"{}trace-\/history-\/debug-\/mode"{}}).as<\textcolor{keywordtype}{bool}>())\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00499}00499\ \ \ \ \ \ \ \ \ \ my-\/>trace\_debug\_mode\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00500}00500\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00501}00501\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00502}00502\ \ \ \ \ \ \ std::optional<state\_history\_log\_prune\_config>\ ship\_log\_prune\_conf;}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00503}00503\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (options.count(\textcolor{stringliteral}{"{}state-\/history-\/log-\/retain-\/blocks"{}}))\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00504}00504\ \ \ \ \ \ \ \ \ \ ship\_log\_prune\_conf.emplace();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00505}00505\ \ \ \ \ \ \ \ \ \ ship\_log\_prune\_conf-\/>prune\_blocks\ =\ options.at(\textcolor{stringliteral}{"{}state-\/history-\/log-\/retain-\/blocks"{}}).as<\mbox{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}}>();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00506}00506\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//the\ arbitrary\ limit\ of\ 1000\ here\ is\ mainly\ so\ that\ there\ is\ enough\ buffer\ for\ newly\ applied\ forks\ to\ be\ delivered\ to\ clients}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00507}00507\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ before\ getting\ pruned\ out.\ ideally\ pruning\ would\ have\ been\ smart\ enough\ to\ know\ not\ to\ prune\ reversible\ blocks}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00508}00508\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{chain_2include_2sysio_2chain_2exceptions_8hpp_a40c2826a6fba35c1ffbf912bdf559792}{SYS\_ASSERT}}(ship\_log\_prune\_conf-\/>prune\_blocks\ >=\ 1000,\ plugin\_exception,\ \textcolor{stringliteral}{"{}state-\/history-\/log-\/retain-\/blocks\ must\ be\ 1000\ blocks\ or\ greater"{}});}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00509}00509\ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00510}00510\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00511}00511\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (options.at(\textcolor{stringliteral}{"{}trace-\/history"{}}).as<\textcolor{keywordtype}{bool}>())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00512}00512\ \ \ \ \ \ \ \ \ \ my-\/>trace\_log.emplace(\textcolor{stringliteral}{"{}trace\_history"{}},\ (state\_history\_dir\ /\ \textcolor{stringliteral}{"{}trace\_history.log"{}}).\textcolor{keywordtype}{string}(),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00513}00513\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (state\_history\_dir\ /\ \textcolor{stringliteral}{"{}trace\_history.index"{}}).\textcolor{keywordtype}{string}(),\ ship\_log\_prune\_conf);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00514}00514\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (options.at(\textcolor{stringliteral}{"{}chain-\/state-\/history"{}}).as<\textcolor{keywordtype}{bool}>())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00515}00515\ \ \ \ \ \ \ \ \ \ my-\/>chain\_state\_log.emplace(\textcolor{stringliteral}{"{}chain\_state\_history"{}},\ (state\_history\_dir\ /\ \textcolor{stringliteral}{"{}chain\_state\_history.log"{}}).\textcolor{keywordtype}{string}(),}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00516}00516\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (state\_history\_dir\ /\ \textcolor{stringliteral}{"{}chain\_state\_history.index"{}}).\textcolor{keywordtype}{string}(),\ ship\_log\_prune\_conf);}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00517}00517\ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00518}00518\ \ \ \ \mbox{\hyperlink{exception_8hpp_ae70bfa24f5a3bc0917382b3c17fc033c}{FC\_LOG\_AND\_RETHROW}}()}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00519}00519\ \}\ \textcolor{comment}{//\ state\_history\_plugin::plugin\_initialize}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00520}00520\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00521}\mbox{\hyperlink{classsysio_1_1state__history__plugin_a11806ee15ae9ff7d0b21e098da8fc1b3}{00521}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_a11806ee15ae9ff7d0b21e098da8fc1b3}{state\_history\_plugin::plugin\_startup}}()\ \{\ my-\/>listen();\ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00522}00522\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00523}\mbox{\hyperlink{classsysio_1_1state__history__plugin_afea0692da6ca1e8c15dfab9d8adbbb18}{00523}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classsysio_1_1state__history__plugin_afea0692da6ca1e8c15dfab9d8adbbb18}{state\_history\_plugin::plugin\_shutdown}}()\ \{}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00524}00524\ \ \ \ my-\/>applied\_transaction\_connection.reset();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00525}00525\ \ \ \ my-\/>accepted\_block\_connection.reset();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00526}00526\ \ \ \ my-\/>block\_start\_connection.reset();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00527}00527\ \ \ \ \textcolor{keywordflow}{while}\ (!my-\/>sessions.empty())}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00528}00528\ \ \ \ \ \ \ my-\/>sessions.begin()-\/>second-\/>close();}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00529}00529\ \ \ \ my-\/>stopping\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00530}00530\ \}}
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00531}00531\ }
\DoxyCodeLine{\Hypertarget{state__history__plugin_8cpp_source_l00532}00532\ \}\ \textcolor{comment}{//\ namespace\ sysio}}

\end{DoxyCode}

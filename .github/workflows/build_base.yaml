name: "Build sysio"

on:
  workflow_call:
    inputs:
      platforms:
        description: "Platforms definitions"
        type: string
        required: true
      platform-list:
        description: "Array of platforms"
        type: string
        required: true

permissions:
  packages: read
  contents: read

defaults:
  run:
    shell: bash

jobs:
  Build:
    name: Build wire-sysio
    strategy:
      fail-fast: false
      matrix:
        platform: ${{fromJSON(inputs.platform-list)}}
    runs-on: ["self-hosted", "enf-x86-beefy"]
    container: ${{fromJSON(inputs.platforms)[matrix.platform].image}}
    steps:
        - uses: actions/checkout@v4
          with:
            submodules: recursive
        - name: Build
          id: build
          run: |
            # https://github.com/actions/runner/issues/2033
            echo $PWD
            ls -la
            apt-get update && apt-get install -y curl zip unzip tar
            ./vcpkg/bootstrap-vcpkg.sh
            env BASE_DIR=/opt/llvm ./scripts/llvm-11/llvm-11-ubuntu-build-source.sh
            chown -R $(id -u):$(id -g) $PWD
            env CC=/usr/bin/clang-18 CXX=/usr/bin/clang++-18 \
            cmake -B build -S . -G Ninja \
              -DCMAKE_C_COMPILER=$CC \
              -DCMAKE_CXX_COMPILER=$CXX \
              -DCMAKE_TOOLCHAIN_FILE=$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=/opt/llvm/llvm-11 
            cmake --build build -- -j 6
            tar -pc --exclude "*.o" build | zstd --long -T0 -9 > build.tar.zst
        - name: Upload builddir
          uses: actions/upload-artifact@v4
          with:
            name: ${{matrix.platform}}-build
            path: build.tar.zst
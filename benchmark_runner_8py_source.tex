\doxysection{benchmark\+Runner.\+py}
\hypertarget{benchmark_runner_8py_source}{}\label{benchmark_runner_8py_source}\index{libraries/sys-\/vm/external/Catch2/scripts/benchmarkRunner.py@{libraries/sys-\/vm/external/Catch2/scripts/benchmarkRunner.py}}
\mbox{\hyperlink{benchmark_runner_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00001}\mbox{\hyperlink{namespacebenchmark_runner}{00001}}\ \textcolor{comment}{\#!/usr/bin/env\ python3}}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00003}00003\ \textcolor{keyword}{import}\ subprocess,\ os,\ sys}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00004}00004\ \textcolor{keyword}{import}\ xml.etree.ElementTree\ \textcolor{keyword}{as}\ ET}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00005}00005\ \textcolor{keyword}{from}\ collections\ \textcolor{keyword}{import}\ defaultdict}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00006}00006\ \textcolor{keyword}{from}\ statistics\ \textcolor{keyword}{import}\ median,\ stdev}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00007}00007\ \textcolor{keyword}{from}\ datetime\ \textcolor{keyword}{import}\ datetime}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00008}00008\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00009}\mbox{\hyperlink{namespacebenchmark_runner_a6238f79c2fd6e2cae0ea0db150538657}{00009}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacebenchmark_runner_a6238f79c2fd6e2cae0ea0db150538657}{get\_commit\_hash}}():}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00010}00010\ \ \ \ \ res\ =\ subprocess.run(\textcolor{stringliteral}{'git\ rev-\/parse\ HEAD'}.split(),\ check=\textcolor{keyword}{True},\ stdout=subprocess.PIPE,\ universal\_newlines=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00011}00011\ \ \ \ \ \textcolor{keywordflow}{return}\ res.stdout.strip()}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00013}00013\ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{yubihsm__pkcs11_8c_a7360b55975153b822efc5217b7734e6a}{len}}(sys.argv)\ <\ 2:}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00014}00014\ \ \ \ \ \mbox{\hyperlink{210-_evt-_event_listeners_8cpp_a91b9457094088a57b7ba14d485a8771e}{print}}(\textcolor{stringliteral}{'Usage:\ \{\}\ benchmark-\/binary'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(sys.argv[0]))}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00015}00015\ \ \ \ \ exit(1)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00016}00016\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00018}\mbox{\hyperlink{namespacebenchmark_runner_ac26069aa4a12adff28549b711417ab46}{00018}}\ num\_runs\ =\ 10}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00019}\mbox{\hyperlink{namespacebenchmark_runner_a26eca9077b5fd308a89ed77fbbad704c}{00019}}\ data\ =\ defaultdict(list)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00022}\mbox{\hyperlink{namespacebenchmark_runner_a3c7e0616314c0b102caf1d230c9e4ba9}{00022}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacebenchmark_runner_a3c7e0616314c0b102caf1d230c9e4ba9}{parse\_file}}(file):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00024}00024\ \ \ \ \ \textcolor{keyword}{def\ }recursive\_search(node):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00025}00025\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ node.tag\ ==\ \textcolor{stringliteral}{'TestCase'}:}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00026}00026\ \ \ \ \ \ \ \ \ \ \ \ \ results\ =\ node.find(\textcolor{stringliteral}{'OverallResult'})}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00027}00027\ \ \ \ \ \ \ \ \ \ \ \ \ time\ =\ results.get(\textcolor{stringliteral}{'durationInSeconds'})}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00028}00028\ \ \ \ \ \ \ \ \ \ \ \ \ data[node.get(\textcolor{stringliteral}{'name'})].append(float(time))}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00029}00029\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ node.tag\ \textcolor{keywordflow}{in}\ (\textcolor{stringliteral}{'Group'},\ \textcolor{stringliteral}{'Catch'}):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ child\ \textcolor{keywordflow}{in}\ node:}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ recursive\_search(child)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00033}00033\ \ \ \ \ tree\ =\ ET.parse(file)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00034}00034\ \ \ \ \ recursive\_search(tree.getroot())}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00035}00035\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00036}\mbox{\hyperlink{namespacebenchmark_runner_a436df00fcedb6fb74b41ddc263d9bf53}{00036}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacebenchmark_runner_a436df00fcedb6fb74b41ddc263d9bf53}{run\_benchmarks}}(binary):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00037}00037\ \ \ \ \ call\ =\ [binary]\ +\ \textcolor{stringliteral}{'-\/d\ yes\ -\/r\ xml\ -\/o'}.split()}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00038}00038\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ range(num\_runs):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00039}00039\ \ \ \ \ \ \ \ \ file\ =\ \textcolor{stringliteral}{'temp\{\}.xml'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(i)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{210-_evt-_event_listeners_8cpp_a91b9457094088a57b7ba14d485a8771e}{print}}(\textcolor{stringliteral}{'Run\ number\ \{\}'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(i))}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ subprocess.run(call\ +\ [file])}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacebenchmark_runner_a3c7e0616314c0b102caf1d230c9e4ba9}{parse\_file}}(file)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Remove\ file\ right\ after\ parsing,\ because\ benchmark\ output\ can\ be\ big}}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ os.remove(file)}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00045}00045\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00047}00047\ \textcolor{comment}{\#\ Run\ benchmarks}}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00048}00048\ \mbox{\hyperlink{namespacebenchmark_runner_a436df00fcedb6fb74b41ddc263d9bf53}{run\_benchmarks}}(sys.argv[1])}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00050}\mbox{\hyperlink{namespacebenchmark_runner_ad1a9cc1f96a535f9c91ebf13cf7f0905}{00050}}\ result\_file\ =\ \textcolor{stringliteral}{'\{:\%Y-\/\%m-\/\%dT\%H-\/\%M-\/\%S\}-\/\{\}.result'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(datetime.now(),\ \mbox{\hyperlink{namespacebenchmark_runner_a6238f79c2fd6e2cae0ea0db150538657}{get\_commit\_hash}}())}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00051}00051\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00053}00053\ \mbox{\hyperlink{210-_evt-_event_listeners_8cpp_a91b9457094088a57b7ba14d485a8771e}{print}}(\textcolor{stringliteral}{'Writing\ results\ to\ \{\}'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(result\_file))}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00054}00054\ \textcolor{keyword}{with}\ open(result\_file,\ \textcolor{stringliteral}{'w'})\ \textcolor{keyword}{as}\ file:}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00055}00055\ \ \ \ \ \textcolor{keywordflow}{for}\ k\ \textcolor{keywordflow}{in}\ sorted(data):}
\DoxyCodeLine{\Hypertarget{benchmark_runner_8py_source_l00056}00056\ \ \ \ \ \ \ \ \ file.write(\textcolor{stringliteral}{'\{\}:\ median:\ \{\}\ (s),\ stddev:\ \{\}\ (s)\(\backslash\)n'}.\mbox{\hyperlink{yubihsm-shell_8h_ae425c09a4c40409de33790765339cb97}{format}}(k,\ median(data[k]),\ stdev(data[k])))}

\end{DoxyCode}
